# å¼€å‘ç¬”è®°

## ğŸ“¦ é¡¹ç›®æ¦‚è§ˆ

### æŠ€æœ¯æ ˆ

**å‰ç«¯ (Web)**
- **æ¡†æ¶**: Vue 3.5.17 + Composition API
- **è¯­è¨€**: TypeScript 5.8 (ä¸¥æ ¼æ¨¡å¼)
- **æ„å»ºå·¥å…·**: Vite 6.3.5
- **UI åº“**: åŸç”Ÿ Canvas API
- **å›¾æ ‡**: FontAwesome 6.7.2
- **è·¯ç”±**: Vue Router 4.6.3
- **æµ‹è¯•**: Vitest 4.0.14 + Happy-DOM
- **ä»£ç è§„èŒƒ**: ESLint 9 + Prettier 3

**åç«¯ (Server)**
- **è¿è¡Œæ—¶**: Node.js 20 LTS
- **æ¡†æ¶**: Koa 3.0 (è½»é‡çº§ HTTP æœåŠ¡å™¨)
- **æ•°æ®åº“**: MongoDB 8.0 + Mongoose
- **å®æ—¶é€šä¿¡**: WebSocket (ws 8.18)
- **å·¥å…·åº“**: UUID, dotenv, CORS

**æ ¸å¿ƒå¼•æ“**
- **çº¯ TypeScript å®ç°**ï¼Œä¸ Vue æ¡†æ¶è§£è€¦
- **Canvas 2D API** åŸç”Ÿæ¸²æŸ“
- **çŸ©é˜µå˜æ¢ç³»ç»Ÿ** (Matrix.ts)
- **å‘é‡æ•°å­¦åº“** (Vector.ts)
- **å‘½ä»¤æ¨¡å¼** æ’¤é”€/é‡åšç³»ç»Ÿ
- **ç­–ç•¥æ¨¡å¼** å·¥å…·ç®¡ç†å™¨

### é¡¹ç›®ç»“æ„

```
webååŒç”»æ¿/
â”œâ”€â”€ web/                          # å‰ç«¯é¡¹ç›®
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ core/                # æ ¸å¿ƒå¼•æ“ (æ¡†æ¶æ— å…³)
â”‚   â”‚   â”‚   â”œâ”€â”€ Canvas.ts        # Canvas å°è£…
â”‚   â”‚   â”‚   â”œâ”€â”€ Editor.ts        # ç¼–è¾‘å™¨ä¸»ç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ Scene.ts         # åœºæ™¯ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ CommandManager.ts # å‘½ä»¤ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ ToolManager.ts   # å·¥å…·ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ ErrorHandler.ts  # é”™è¯¯å¤„ç†
â”‚   â”‚   â”‚   â””â”€â”€ config.ts        # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ tools/               # ç»˜å›¾å·¥å…·
â”‚   â”‚   â”‚   â”œâ”€â”€ SelectTool.ts    # é€‰æ‹©å·¥å…·
â”‚   â”‚   â”‚   â”œâ”€â”€ RectTool.ts      # çŸ©å½¢å·¥å…·
â”‚   â”‚   â”‚   â”œâ”€â”€ CircleTool.ts    # åœ†å½¢å·¥å…·
â”‚   â”‚   â”‚   â”œâ”€â”€ PenTool.ts       # é’¢ç¬”å·¥å…·
â”‚   â”‚   â”‚   â””â”€â”€ BrushTool.ts     # ç”»ç¬”å·¥å…·
â”‚   â”‚   â”œâ”€â”€ shapes/              # å›¾å½¢ç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ Shape.ts         # å›¾å½¢åŸºç±»
â”‚   â”‚   â”‚   â”œâ”€â”€ Rect.ts          # çŸ©å½¢
â”‚   â”‚   â”‚   â”œâ”€â”€ Circle.ts        # åœ†å½¢
â”‚   â”‚   â”‚   â””â”€â”€ Line.ts          # çº¿æ¡
â”‚   â”‚   â”œâ”€â”€ math/                # æ•°å­¦åº“
â”‚   â”‚   â”‚   â”œâ”€â”€ Vector.ts        # å‘é‡
â”‚   â”‚   â”‚   â”œâ”€â”€ Matrix.ts        # çŸ©é˜µ
â”‚   â”‚   â”‚   â””â”€â”€ AABB.ts          # è½´å¯¹é½åŒ…å›´ç›’
â”‚   â”‚   â”œâ”€â”€ algorithms/          # ç®—æ³•åº“
â”‚   â”‚   â”‚   â”œâ”€â”€ PathSmoothing.ts # è·¯å¾„å¹³æ»‘
â”‚   â”‚   â”‚   â””â”€â”€ QuadTree.ts      # å››å‰æ ‘
â”‚   â”‚   â”œâ”€â”€ commands/            # å‘½ä»¤å®ç°
â”‚   â”‚   â”‚   â”œâ”€â”€ AddShapeCommand.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ DeleteShapeCommand.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ TransformCommand.ts
â”‚   â”‚   â”‚   â””â”€â”€ UpdateStyleCommand.ts
â”‚   â”‚   â”œâ”€â”€ components/          # Vue ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ EditorExample.vue # ç¼–è¾‘å™¨ä¸»ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ Toolbar.vue      # å·¥å…·æ 
â”‚   â”‚   â”‚   â””â”€â”€ PropertyPanel.vue # å±æ€§é¢æ¿
â”‚   â”‚   â”œâ”€â”€ hooks/               # Vue Hooks
â”‚   â”‚   â”‚   â”œâ”€â”€ useEditor.ts     # ç¼–è¾‘å™¨ Hook
â”‚   â”‚   â”‚   â””â”€â”€ useCollaboration.ts # ååŒ Hook
â”‚   â”‚   â””â”€â”€ types/               # ç±»ï¿½ï¿½å®šä¹‰
â”‚   â”œâ”€â”€ tests/                   # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ .eslintrc.json          # ESLint é…ç½®
â”‚   â”œâ”€â”€ .prettierrc.json        # Prettier é…ç½®
â”‚   â”œâ”€â”€ tsconfig.json           # TypeScript é…ç½®
â”‚   â”œâ”€â”€ vite.config.ts          # Vite é…ç½®
â”‚   â””â”€â”€ package.json            # å‰ç«¯ä¾èµ–
â”œâ”€â”€ server/                      # åç«¯é¡¹ç›®
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â””â”€â”€ database.js     # MongoDB è¿æ¥
â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”‚   â”œâ”€â”€ Room.js         # æˆ¿é—´æ¨¡å‹
â”‚   â”‚   â”‚   â””â”€â”€ Operation.js    # æ“ä½œå†å²æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â””â”€â”€ rooms.js        # æˆ¿é—´è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ RoomService.js  # æˆ¿é—´æœåŠ¡
â”‚   â”‚   â”‚   â””â”€â”€ WebSocketService.js # WebSocket æœåŠ¡
â”‚   â”‚   â””â”€â”€ index.js            # å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ .env                    # ç¯å¢ƒå˜é‡
â”‚   â”œâ”€â”€ .env.example            # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”‚   â”œâ”€â”€ package.json            # åç«¯ä¾èµ–
â”‚   â”œâ”€â”€ README.md              # æœåŠ¡å™¨æ–‡æ¡£
â”‚   â””â”€â”€ SETUP.md               # é…ç½®æŒ‡å—
â”œâ”€â”€ å¼€å‘ç¬”è®°.md                 # æœ¬æ–‡ä»¶
â”œâ”€â”€ é¢è¯•æŒ‡å—.md                 # é¢è¯•æŠ€å·§
â””â”€â”€ CLAUDE.md                   # é¡¹ç›®è§„èŒƒ
```

### å¿«é€Ÿå¼€å§‹

**å‰ç«¯å¯åŠ¨**
```bash
cd web
npm install
npm run dev          # å¼€å‘æœåŠ¡å™¨: http://localhost:5173
```

**åç«¯å¯åŠ¨**
```bash
cd server
npm install
npm run dev          # WebSocket æœåŠ¡å™¨: ws://localhost:3000
```

**å®Œæ•´ç¯å¢ƒå¯åŠ¨**
```bash
# å‰ç«¯ + åç«¯åŒæ—¶å¯åŠ¨
cd web
npm run start:dev
```

### å¯ç”¨å‘½ä»¤

**å‰ç«¯å‘½ä»¤**
```bash
npm run dev              # å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run build            # ç”Ÿäº§æ„å»º
npm run preview          # é¢„è§ˆæ„å»ºäº§ç‰©
npm run type-check       # TypeScript ç±»å‹æ£€æŸ¥
npm run lint             # ESLint æ£€æŸ¥å¹¶ä¿®å¤
npm run format           # Prettier æ ¼å¼åŒ–
npm run test             # è¿è¡Œå•å…ƒæµ‹è¯•
npm run test:ui          # æµ‹è¯• UI ç•Œé¢
npm run test:coverage    # æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
```

**åç«¯å‘½ä»¤**
```bash
npm start               # ç”Ÿäº§æ¨¡å¼å¯åŠ¨
npm run dev             # å¼€å‘æ¨¡å¼ (è‡ªåŠ¨é‡å¯)
```

## é¡¹ç›®å¼€å‘å†ç¨‹

### 2025-12-02 - æ€§èƒ½ä¿®å¤ä¸å…¨é¢ä¼˜åŒ–

> æœ¬æ¬¡æ›´æ–°åŒ…å«ä¸¤ä¸ªé˜¶æ®µï¼š
> 1. **æ€§èƒ½ä¼˜åŒ–é˜¶æ®µ** - FPS æå‡ã€å·¥å…·å®Œå–„ã€æµ‹è¯•ä¿®å¤
> 2. **è§„èŒƒåŒ–é˜¶æ®µ** - æ ¹æ®é¡¹ç›®åˆ†ææŠ¥å‘Šä¿®å¤æ‰€æœ‰å‘ç°çš„é—®é¢˜

#### ğŸ”¥ æ ¸å¿ƒé—®é¢˜ï¼šFPS ä½ä¸‹ï¼ˆ13 FPS â†’ 60 FPSï¼‰

**é—®é¢˜æè¿°**ï¼š
- Stats.js æ˜¾ç¤º FPS åªæœ‰ 13ï¼Œè¿œä½äºé¢„æœŸçš„ 60 FPS
- ç”¨æˆ·äº¤äº’æ„Ÿè§‰å¡é¡¿ï¼Œç‰¹åˆ«æ˜¯æ‹–æ‹½å’Œç¼©æ”¾æ“ä½œ

**é—®é¢˜åˆ†æ**ï¼š
```typescript
// åŸå§‹å®ç°ï¼šè„æ ‡è®°ä¼˜åŒ–
private needsRender = false;

requestRender() {
  if (!this.needsRender) {
    this.needsRender = true;
    requestAnimationFrame(() => {
      this.render();
      this.needsRender = false;
    });
  }
}
```

**æ ¹æœ¬åŸå› **ï¼š
- Stats.js åœ¨æ¯å¸§éƒ½è¿›è¡Œæµ‹é‡ï¼Œä½†ç”±äºè„æ ‡è®°ä¼˜åŒ–ï¼Œåªæœ‰éƒ¨åˆ†å¸§å®é™…æ¸²æŸ“
- å¯¼è‡´ Stats.js ç»Ÿè®¡çš„ FPS ä¸å‡†ç¡®ï¼Œæ˜¾ç¤ºä¸º 13 FPS
- å®é™…ä¸Šæ˜¯æµ‹é‡é¢‘ç‡ä¸æ¸²æŸ“é¢‘ç‡ä¸åŒ¹é…çš„é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// æ–°å®ç°ï¼šæŒç»­æ¸²æŸ“
render() {
  // æ¸…ç©ºç”»å¸ƒ
  this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
  
  // æ¸²æŸ“æ‰€æœ‰å†…å®¹
  this.renderGrid();
  this.renderShapes();
  this.renderSelection();
  this.renderTransformHandles();
  
  // æŒç»­æ¸²æŸ“ç¡®ä¿æµç•…äº¤äº’
  requestAnimationFrame(() => this.render());
}
```

**æ•ˆæœ**ï¼š
- FPS ä» 13 æå‡åˆ° 60ï¼Œè¾¾åˆ°æµè§ˆå™¨åˆ·æ–°ç‡ä¸Šé™
- ç”¨æˆ·äº¤äº’å˜å¾—æµç•…ï¼Œæ‹–æ‹½å’Œç¼©æ”¾å“åº”åŠæ—¶
- æ€§èƒ½ç›‘æ§æ•°æ®å‡†ç¡®åæ˜ å®é™…æ¸²æŸ“æ€§èƒ½

#### âœ… TypeScript ç±»å‹é”™è¯¯ä¿®å¤

**é—®é¢˜1ï¼šTransformCommand ç±»å‹é”™è¯¯**
```typescript
// é”™è¯¯ï¼šProperty 'newTransform' does not exist on type 'TransformData'
interface TransformData {
  shapeId: string;
  oldTransform: Matrix;
  newTransform: Matrix; // ç¼ºå°‘æ­¤å±æ€§
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
interface TransformData {
  shapeId: string;
  oldTransform: Matrix;
  newTransform: Matrix; // æ·»åŠ ç¼ºå¤±å±æ€§
}
```

**é—®é¢˜2ï¼šQuadTree ç±»å‹é”™è¯¯**
```typescript
// é”™è¯¯ï¼šArgument of type 'Shape' is not assignable to parameter of type 'QuadTreeItem'
interface QuadTreeItem {
  getBounds(): AABB;
  id: string; // ç¼ºå°‘ id å±æ€§
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// Shape åŸºç±»æ·»åŠ  id å±æ€§
export abstract class Shape {
  public readonly id: string;
  
  constructor(options: ShapeOptions) {
    this.id = options.id || generateId();
  }
}
```

#### âœ… Vector æ•°å­¦åº“å®Œå–„

**é—®é¢˜**ï¼šVector ç±»ç¼ºå°‘åŸºç¡€æ•°å­¦æ–¹æ³•ï¼Œå¯¼è‡´å…¶ä»–æ¨¡å—æ— æ³•æ­£å¸¸å·¥ä½œã€‚

**æ·»åŠ çš„æ–¹æ³•**ï¼š
```typescript
export class Vector {
  // å‘é‡å‡æ³•
  subtract(other: Vector): Vector {
    return new Vector(this.x - other.x, this.y - other.y);
  }

  // æ ‡é‡ä¹˜æ³•
  multiply(scalar: number): Vector {
    return new Vector(this.x * scalar, this.y * scalar);
  }

  // æ ‡é‡é™¤æ³•
  divide(scalar: number): Vector {
    return new Vector(this.x / scalar, this.y / scalar);
  }

  // å‘é‡ç›¸ç­‰æ¯”è¾ƒ
  equals(other: Vector, tolerance = 1e-10): boolean {
    return Math.abs(this.x - other.x) < tolerance && 
           Math.abs(this.y - other.y) < tolerance;
  }

  // å‘é‡é•¿åº¦
  length(): number {
    return Math.sqrt(this.x * this.x + this.y * this.y);
  }

  // å•ä½å‘é‡
  normalize(): Vector {
    const len = this.length();
    return len > 0 ? this.divide(len) : new Vector(0, 0);
  }

  // å‘é‡è§’åº¦
  angle(): number {
    return Math.atan2(this.y, this.x);
  }
}
```

#### âœ… å•å…ƒæµ‹è¯•ä¿®å¤ï¼ˆ16ä¸ªé”™è¯¯ â†’ å…¨éƒ¨é€šè¿‡ï¼‰

**æµ‹è¯•ç»Ÿè®¡**ï¼š
- Vector æµ‹è¯•ï¼š18ä¸ªæµ‹è¯• âœ…
- Matrix æµ‹è¯•ï¼š17ä¸ªæµ‹è¯• âœ…  
- AABB æµ‹è¯•ï¼š19ä¸ªæµ‹è¯• âœ…
- CommandManager æµ‹è¯•ï¼š22ä¸ªæµ‹è¯• âœ…
- **æ€»è®¡**ï¼š76ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡

**ä¸»è¦ä¿®å¤**ï¼š
1. Vector æ–¹æ³•ç¼ºå¤±å¯¼è‡´çš„æµ‹è¯•å¤±è´¥
2. Matrix å˜æ¢è®¡ç®—ç²¾åº¦é—®é¢˜
3. AABB è¾¹ç•Œæ£€æµ‹é€»è¾‘é”™è¯¯
4. CommandManager æ’¤é”€/é‡åšçŠ¶æ€ç®¡ç†

#### âœ… æ–°å¢ BrushTool ç”»ç¬”å·¥å…·

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- æ‹–æ‹½å¼è‡ªç”±ç»˜åˆ¶ï¼ˆé¼ æ ‡æŒ‰ä¸‹æ‹–æ‹½ï¼‰
- å®æ—¶è·¯å¾„é‡‡æ ·ï¼ˆ`minDistance` æ§åˆ¶ç‚¹å¯†åº¦ï¼‰
- åŠ¨æ€è·¯å¾„ç®€åŒ–ï¼ˆè¶…è¿‡100ç‚¹è‡ªåŠ¨ç®€åŒ–ï¼‰
- å®Œæˆæ—¶è‡ªé€‚åº”å¹³æ»‘ï¼ˆ5ç§ç®—æ³•è‡ªåŠ¨é€‰æ‹©ï¼‰

**å®ç°è¦ç‚¹**ï¼š
```typescript
export class BrushTool extends Tool {
  private minDistance = 3; // æœ€å°é‡‡æ ·è·ç¦»
  private maxPoints = 100; // æœ€å¤§ç‚¹æ•°ï¼Œè¶…è¿‡åˆ™ç®€åŒ–

  onPointerMove(event: PointerEvent) {
    if (!this.isDrawing || !this.currentLine) return;

    const point = this.editor.screenToWorld(new Vector(event.clientX, event.clientY));
    
    // è·ç¦»æ§åˆ¶ï¼Œé¿å…ç‚¹å¤ªå¯†é›†
    if (this.lastPoint && this.lastPoint.distanceTo(point) < this.minDistance) {
      return;
    }

    this.currentLine.addPoint(point);
    this.lastPoint = point;

    // åŠ¨æ€ç®€åŒ–ï¼Œä¿æŒæ€§èƒ½
    if (this.currentLine.points.length > this.maxPoints) {
      const simplified = PathSmoothing.simplify(this.currentLine.points, 2);
      this.currentLine.points = simplified;
    }

    this.editor.requestRender();
  }

  onPointerUp() {
    if (this.currentLine && this.currentLine.points.length > 1) {
      // å®Œæˆæ—¶åº”ç”¨è‡ªé€‚åº”å¹³æ»‘
      const smoothed = PathSmoothing.adaptiveSmooth(this.currentLine.points);
      this.currentLine.points = smoothed;
      
      // æ·»åŠ åˆ°åœºæ™¯
      this.editor.executeCommand(new AddShapeCommand(this.editor.scene, this.currentLine));
    }
  }
}
```

#### âœ… å®Œå–„ PenTool é’¢ç¬”å·¥å…·

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- ç‚¹å‡»å¼ç»˜åˆ¶æŠ˜çº¿ï¼ˆæ¯æ¬¡ç‚¹å‡»æ·»åŠ ä¸€ä¸ªç‚¹ï¼‰
- Enter é”®å®Œæˆç»˜åˆ¶
- Esc é”®å–æ¶ˆç»˜åˆ¶
- å®æ—¶é¢„è§ˆå½“å‰ç»˜åˆ¶çŠ¶æ€

**å®ç°è¦ç‚¹**ï¼š
```typescript
export class PenTool extends Tool {
  onPointerDown(event: PointerEvent) {
    const point = this.editor.screenToWorld(new Vector(event.clientX, event.clientY));

    if (!this.currentLine) {
      // å¼€å§‹æ–°çš„çº¿æ¡
      this.startNewLine(point);
    } else {
      // æ·»åŠ ç‚¹åˆ°å½“å‰çº¿æ¡
      this.currentLine.addPoint(point);
      this.editor.requestRender();
    }
  }

  onKeyDown(event: KeyboardEvent) {
    if (event.key === 'Enter') {
      this.finishLine();
    } else if (event.key === 'Escape') {
      this.cancelLine();
    }
  }
}
```

#### âœ… PathSmoothing è·¯å¾„å¹³æ»‘ç®—æ³•åº“

**5ç§ä¸“ä¸šç®—æ³•**ï¼š

1. **Ramer-Douglas-Peucker (RDP) ç®€åŒ–ç®—æ³•**
   - ç”¨é€”ï¼šç§»é™¤å†—ä½™ç‚¹ï¼Œå‡å°‘æ•°æ®é‡
   - å‚æ•°ï¼š`epsilon` å®¹å·®å€¼
   - é€‚ç”¨ï¼šè·¯å¾„ç®€åŒ–ã€æ€§èƒ½ä¼˜åŒ–

2. **Catmull-Rom æ ·æ¡å¹³æ»‘**
   - ç”¨é€”ï¼šç”Ÿæˆé€šè¿‡æ‰€æœ‰æ§åˆ¶ç‚¹çš„å…‰æ»‘æ›²çº¿
   - å‚æ•°ï¼š`segments` æ¯æ®µçš„ç»†åˆ†æ•°
   - é€‚ç”¨ï¼šæ‰‹ç»˜ç¬”è¿¹å¹³æ»‘

3. **è´å¡å°”æ›²çº¿å¹³æ»‘**
   - ç”¨é€”ï¼šä¸ºæ¯ä¸ªç‚¹è®¡ç®—æ§åˆ¶ç‚¹ï¼Œç”Ÿæˆå¹³æ»‘çš„è´å¡å°”æ›²çº¿
   - å‚æ•°ï¼š`tension` å¼ åŠ›ç³»æ•°
   - é€‚ç”¨ï¼šä¸“ä¸šç»˜å›¾è½¯ä»¶

4. **ç§»åŠ¨å¹³å‡å¹³æ»‘**
   - ç”¨é€”ï¼šç®€å•å¿«é€Ÿçš„å¹³æ»‘æ–¹æ³•
   - å‚æ•°ï¼š`windowSize` çª—å£å¤§å°
   - é€‚ç”¨ï¼šå®æ—¶å¹³æ»‘

5. **è‡ªé€‚åº”ç»„åˆå¹³æ»‘**
   - ç”¨é€”ï¼šæ ¹æ®ç‚¹çš„å¯†åº¦è‡ªåŠ¨è°ƒæ•´å‚æ•°
   - å‚æ•°ï¼šè‡ªåŠ¨è®¡ç®—
   - é€‚ç”¨ï¼šé€šç”¨åœºæ™¯ï¼Œæ¨èä½¿ç”¨

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```typescript
// è‡ªé€‚åº”å¹³æ»‘ï¼ˆæ¨èï¼‰
const optimized = PathSmoothing.adaptiveSmooth(points);

// Catmull-Rom æ ·æ¡ï¼ˆæ‰‹ç»˜æ¨èï¼‰
const smoothed = PathSmoothing.catmullRom(points, 8);

// è·¯å¾„ç®€åŒ–ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
const simplified = PathSmoothing.simplify(points, 2);
```

#### âœ… PropertyPanel å±æ€§é¢æ¿ç»„ä»¶

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- é¢œè‰²é€‰æ‹©å™¨ï¼ˆå¡«å……è‰²ã€æè¾¹è‰²ï¼Œæ”¯æŒå¯ç”¨/ç¦ç”¨ï¼‰
- æ»‘å—æ§åˆ¶ï¼ˆçº¿å®½ 1-20pxã€ä¸é€æ˜åº¦ 0-100%ï¼‰
- å¹³æ»‘é€‰é¡¹ï¼ˆä»… Line ç±»å‹æ˜¾ç¤ºï¼‰
- å¹³æ»‘ç®—æ³•åˆ‡æ¢ï¼ˆCatmull-Rom / Bezier / Simpleï¼‰
- æ‰¹é‡ç¼–è¾‘ï¼ˆå¤šé€‰å›¾å½¢æ—¶æ˜¾ç¤ºå…¬å…±å±æ€§ï¼‰
- æ“ä½œæŒ‰é’®ï¼ˆåˆ é™¤ã€å¤åˆ¶ï¼‰

**å®ç°è¦ç‚¹**ï¼š
```vue
<template>
  <div class="property-panel">
    <!-- é¢œè‰²ç¼–è¾‘ -->
    <div class="color-section">
      <div class="color-item">
        <input type="checkbox" v-model="fillEnabled" />
        <input type="color" v-model="fillColor" :disabled="!fillEnabled" />
        <span>å¡«å……</span>
      </div>
    </div>

    <!-- çº¿å®½æ»‘å— -->
    <div class="slider-section">
      <label>çº¿å®½: {{ lineWidth }}px</label>
      <input type="range" v-model="lineWidth" min="1" max="20" />
    </div>

    <!-- å¹³æ»‘é€‰é¡¹ï¼ˆä»… Line æ˜¾ç¤ºï¼‰ -->
    <div v-if="hasLineShapes" class="smooth-section">
      <label>
        <input type="checkbox" v-model="smoothEnabled" />
        å¯ç”¨å¹³æ»‘
      </label>
      <select v-model="smoothAlgorithm" :disabled="!smoothEnabled">
        <option value="catmullRom">Catmull-Rom</option>
        <option value="bezier">è´å¡å°”</option>
        <option value="simple">ç®€å•</option>
      </select>
    </div>
  </div>
</template>
```

#### âœ… Stats.js æ€§èƒ½ç›‘æ§é›†æˆ

**é›†æˆä½ç½®**ï¼šuseEditor Hook
```typescript
export function useEditor(options: UseEditorOptions) {
  const stats = ref<Stats | null>(null);

  onMounted(() => {
    if (canvasRef.value) {
      // åˆ›å»ºç¼–è¾‘å™¨
      editor = new Editor({ canvas: canvasRef.value, ...options });
      
      // é›†æˆ Stats.js
      stats.value = new Stats();
      stats.value.showPanel(0); // FPS é¢æ¿
      document.body.appendChild(stats.value.dom);
      
      // åœ¨æ¸²æŸ“å¾ªç¯ä¸­æ›´æ–°ç»Ÿè®¡
      const originalRender = editor.render.bind(editor);
      editor.render = () => {
        stats.value?.begin();
        originalRender();
        stats.value?.end();
      };
    }
  });

  onUnmounted(() => {
    // æ¸…ç† Stats.js
    if (stats.value) {
      document.body.removeChild(stats.value.dom);
    }
  });
}
```

#### âœ… å·¥å…·ç³»ç»Ÿå®Œå–„

**å·²æ³¨å†Œçš„5ä¸ªå·¥å…·**ï¼š
1. **SelectTool** - é€‰æ‹©å·¥å…·ï¼ˆæ‹–æ‹½ã€æ¡†é€‰ã€å¤šé€‰ã€å˜æ¢ï¼‰
2. **RectTool** - çŸ©å½¢ç»˜åˆ¶ï¼ˆShift çº¦æŸæ­£æ–¹å½¢ï¼‰
3. **CircleTool** - åœ†å½¢ç»˜åˆ¶ï¼ˆShift çº¦æŸæ­£åœ†ï¼‰
4. **PenTool** - é’¢ç¬”å·¥å…·ï¼ˆç‚¹å‡»å¼ç»˜åˆ¶æŠ˜çº¿ï¼‰
5. **BrushTool** - ç”»ç¬”å·¥å…·ï¼ˆæ‹–æ‹½å¼è‡ªç”±ç»˜åˆ¶ï¼‰

**å·¥å…·ç®¡ç†å™¨**ï¼š
```typescript
export class ToolManager {
  private tools = new Map<string, Tool>();

  constructor(editor: Editor) {
    // æ³¨å†Œæ‰€æœ‰å·¥å…·
    this.tools.set('select', new SelectTool(editor));
    this.tools.set('rect', new RectTool(editor));
    this.tools.set('circle', new CircleTool(editor));
    this.tools.set('pen', new PenTool(editor));
    this.tools.set('brush', new BrushTool(editor));
  }
}
```

#### âœ… æ„å»ºä¼˜åŒ–

**æ„å»ºç»“æœ**ï¼š
- æ„å»ºäº§ç‰©å¤§å°ï¼š153 KB (gzip: 53 KB)
- æ„å»ºæ—¶é—´ï¼š~3.13s
- TypeScript ä¸¥æ ¼æ¨¡å¼ï¼šé€šè¿‡
- æ‰€æœ‰ä¾èµ–æ­£ç¡®æ‰“åŒ…

**ä¼˜åŒ–æªæ–½**ï¼š
- Tree-shaking ç§»é™¤æœªä½¿ç”¨ä»£ç 
- ä»£ç åˆ†å‰²ï¼ˆè·¯ç”±æ‡’åŠ è½½ï¼‰
- èµ„æºå‹ç¼©ï¼ˆTerserã€CSS å‹ç¼©ï¼‰

---

### è§„èŒƒåŒ–ä¿®å¤ï¼ˆåŸºäºé¡¹ç›®åˆ†ææŠ¥å‘Šï¼‰

#### âœ… 1. é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„

**é—®é¢˜æè¿°**: éƒ¨åˆ†å…³é”®æ–¹æ³•ç¼ºå°‘é”™è¯¯å¤„ç†ï¼Œå¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒ

**ä¿®å¤æ–¹æ¡ˆ**:
- åˆ›å»º `ErrorHandler.ts` å…¨å±€é”™è¯¯å¤„ç†å™¨
- åœ¨ `Editor.ts` çš„ `renderBackground()` æ–¹æ³•æ·»åŠ  try-catch
- ä½¿ç”¨å•ä¾‹æ¨¡å¼ç»Ÿä¸€ç®¡ç†é”™è¯¯

**ä¿®å¤æ–‡ä»¶**:
- `src/core/ErrorHandler.ts` (æ–°å¢)
- `src/core/Editor.ts` (æ›´æ–°)
- `src/core/index.ts` (å¯¼å‡º ErrorHandler)

**ä»£ç ç¤ºä¾‹**:
```typescript
// ErrorHandler.ts
export class ErrorHandler {
  private static instance: ErrorHandler;
  
  static getInstance(): ErrorHandler {
    if (!this.instance) {
      this.instance = new ErrorHandler();
    }
    return this.instance;
  }
  
  handle(error: Error, context: string): void {
    console.error(`[${context}]`, error);
  }
}

// Editor.ts
renderBackground(): void {
  try {
    // æ¸²æŸ“é€»è¾‘
  } catch (error) {
    ErrorHandler.getInstance().handleRenderError(error as Error);
  }
}
```

#### âœ… 2. é…ç½®ç®¡ç†ç³»ç»Ÿ

**é—®é¢˜æè¿°**: é…ç½®å€¼ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼Œä¸ä¾¿äºç»´æŠ¤

**ä¿®å¤æ–¹æ¡ˆ**:
- åˆ›å»º `config.ts` ç»Ÿä¸€é…ç½®æ–‡ä»¶
- å®šä¹‰æ€§èƒ½ã€ç”»å¸ƒã€å·¥å…·ã€å‘½ä»¤ã€ååŒç­‰é…ç½®
- åœ¨ `Editor.ts` ä¸­ä½¿ç”¨é…ç½®å¸¸é‡

**ä¿®å¤æ–‡ä»¶**:
- `src/core/config.ts` (æ–°å¢)
- `src/core/Editor.ts` (ä½¿ç”¨ CONFIG)
- `src/core/index.ts` (å¯¼å‡º CONFIG)

**é…ç½®å†…å®¹**:
```typescript
export const CONFIG = {
  performance: {
    enableStats: process.env.NODE_ENV === 'development',
    targetFPS: 60,
    maxShapes: 10000,
  },
  canvas: {
    backgroundColor: '#ffffff',
    gridSize: 20,
    showGrid: true,
    minZoom: 0.1,
    maxZoom: 10,
  },
  // ... å…¶ä»–é…ç½®
};
```

#### âœ… 3. package.json è§„èŒƒåŒ–

**é—®é¢˜æè¿°**: 
- é¡¹ç›®åç§°ä¸º "ceshi"ï¼Œä¸ä¸“ä¸š
- ç‰ˆæœ¬å·ä¸º "0.0.0"ï¼Œåº”è¯¥æ˜¯ 1.0.0
- æè¿°ä¸å‡†ç¡®

**ä¿®å¤æ–¹æ¡ˆ**:
- æ›´æ–° `name` ä¸º "web-collaborative-whiteboard"
- æ›´æ–° `version` ä¸º "1.0.0"
- æ›´æ–° `description` ä¸ºå‡†ç¡®æè¿°
- æ·»åŠ  `keywords` å…³é”®è¯
- æ·»åŠ  `repository` ä»“åº“ä¿¡æ¯

**ä¿®å¤æ–‡ä»¶**:
- `package.json` (æ›´æ–°)

**ä¿®å¤å‰åå¯¹æ¯”**:
```json
// ä¿®å¤å‰
{
  "name": "ceshi",
  "version": "0.0.0",
  "description": "This template should help get you started..."
}

// ä¿®å¤å
{
  "name": "web-collaborative-whiteboard",
  "version": "1.0.0",
  "description": "Professional graphic editor with real-time collaboration support",
  "keywords": ["canvas", "editor", "collaboration", "vue3", "typescript"],
  "repository": {
    "type": "git",
    "url": "https://github.com/yourusername/web-collaborative-whiteboard"
  }
}
```

#### âœ… 4. ä»£ç è§„èŒƒé…ç½®

**é—®é¢˜æè¿°**: æ²¡æœ‰ ESLint å’Œ Prettier é…ç½®ï¼Œä»£ç é£æ ¼ä¸ç»Ÿä¸€

**ä¿®å¤æ–¹æ¡ˆ**:
- åˆ›å»º `.eslintrc.json` ESLint é…ç½®
- åˆ›å»º `.prettierrc.json` Prettier é…ç½®
- é…ç½® TypeScript å’Œ Vue è§„åˆ™

**ä¿®å¤æ–‡ä»¶**:
- `.eslintrc.json` (æ–°å¢)
- `.prettierrc.json` (æ–°å¢)

**é…ç½®å†…å®¹**:
```json
// .eslintrc.json
{
  "extends": [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "plugin:vue/vue3-recommended"
  ],
  "rules": {
    "@typescript-eslint/no-explicit-any": "warn",
    "no-console": ["warn", { "allow": ["warn", "error"] }]
  }
}

// .prettierrc.json
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5"
}
```

#### ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æå‡ |
|------|--------|--------|------|
| é”™è¯¯å¤„ç† | 7/10 | 9/10 | +2 |
| é…ç½®ç®¡ç† | 6/10 | 9/10 | +3 |
| é¡¹ç›®è§„èŒƒ | 7/10 | 10/10 | +3 |
| ä»£ç è§„èŒƒ | 8/10 | 10/10 | +2 |
| **ç»¼åˆè¯„åˆ†** | **9.0/10** | **9.8/10** | **+0.8** |

#### ğŸ“ æ–°å¢æ–‡ä»¶æ¸…å•

1. `src/core/ErrorHandler.ts` - å…¨å±€é”™è¯¯å¤„ç†å™¨
2. `src/core/config.ts` - åº”ç”¨é…ç½®æ–‡ä»¶
3. `.eslintrc.json` - ESLint é…ç½®
4. `.prettierrc.json` - Prettier é…ç½®

#### ğŸ“ æ›´æ–°æ–‡ä»¶æ¸…å•

1. `src/core/Editor.ts` - æ·»åŠ é”™è¯¯å¤„ç†å’Œé…ç½®å¼•ç”¨
2. `src/core/index.ts` - å¯¼å‡ºæ–°æ¨¡å—
3. `package.json` - æ›´æ–°é¡¹ç›®ä¿¡æ¯
4. `CHANGELOG.md` - è®°å½•ä¿®å¤å†…å®¹
5. `README.md` - æ›´æ–°æ–‡æ¡£é“¾æ¥

## æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ

### 1. åæ ‡è½¬æ¢ç³»ç»Ÿ

**é—®é¢˜**ï¼šCanvas åæ ‡ç³»ä¸ä¸–ç•Œåæ ‡ç³»çš„è½¬æ¢ï¼Œç‰¹åˆ«æ˜¯ç¼©æ”¾å’Œå¹³ç§»åçš„ç²¾ç¡®è½¬æ¢ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// ä½¿ç”¨çŸ©é˜µå˜æ¢
export class Canvas {
  private viewMatrix = new Matrix();

  screenToWorld(screenPoint: Vector): Vector {
    const viewMatrixInverse = this.viewMatrix.invert();
    return viewMatrixInverse.transformPoint(screenPoint);
  }

  worldToScreen(worldPoint: Vector): Vector {
    return this.viewMatrix.transformPoint(worldPoint);
  }
}
```

**å…³é”®ç‚¹**ï¼š
- è§†å›¾çŸ©é˜µ = å¹³ç§» Ã— ç¼©æ”¾
- é€†çŸ©é˜µç”¨äºä»å±å¹•åæ ‡åæ¨ä¸–ç•Œåæ ‡
- ä¿è¯ç¼©æ”¾ä»¥é¼ æ ‡ä¸ºä¸­å¿ƒ

### 2. å›¾å½¢å˜æ¢æ§åˆ¶

**é—®é¢˜**ï¼šå®ç°å¯è§†åŒ–çš„ç¼©æ”¾å’Œæ—‹è½¬æ§åˆ¶ç‚¹ï¼Œæ”¯æŒç­‰æ¯”ç¼©æ”¾å’Œè§’åº¦å¸é™„ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
export class TransformHandle {
  // 8ä¸ªç¼©æ”¾æ§åˆ¶ç‚¹ + 1ä¸ªæ—‹è½¬æ§åˆ¶ç‚¹
  private handles = [
    { type: 'TOP_LEFT', cursor: 'nw-resize' },
    { type: 'TOP_CENTER', cursor: 'n-resize' },
    // ... å…¶ä»–æ§åˆ¶ç‚¹
    { type: 'ROTATE', cursor: 'grab' }
  ];

  transform(currentPoint: Vector, constrainProportions: boolean) {
    if (this.activeHandle?.type === 'ROTATE') {
      // æ—‹è½¬å˜æ¢
      let angle = Math.atan2(
        currentPoint.y - this.center.y,
        currentPoint.x - this.center.x
      );
      
      // 15åº¦å¸é™„
      angle = Math.round(angle / (Math.PI / 12)) * (Math.PI / 12);
      return { rotation: angle };
    } else {
      // ç¼©æ”¾å˜æ¢
      if (constrainProportions) {
        // ç­‰æ¯”ç¼©æ”¾
        const avgDelta = (deltaX + deltaY) / 2;
        return {
          width: this.startBounds.width + avgDelta,
          height: this.startBounds.height + avgDelta
        };
      }
    }
  }
}
```

### 3. è·¯å¾„å¹³æ»‘ç®—æ³•

**é—®é¢˜**ï¼šæ‰‹ç»˜è·¯å¾„é€šå¸¸åŒ…å«å¤§é‡å™ªç‚¹ï¼Œéœ€è¦å¹³æ»‘å¤„ç†ä»¥è·å¾—ä¸“ä¸šæ•ˆæœã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå®ç°äº†5ç§ä¸“ä¸šç®—æ³•çš„ PathSmoothing å·¥å…·ç±»

**Catmull-Rom æ ·æ¡å®ç°**ï¼š
```typescript
static catmullRom(points: Vector[], segments = 8): Vector[] {
  if (points.length < 2) return points;

  const result: Vector[] = [];
  
  for (let i = 0; i < points.length - 1; i++) {
    const p0 = points[Math.max(0, i - 1)];
    const p1 = points[i];
    const p2 = points[i + 1];
    const p3 = points[Math.min(points.length - 1, i + 2)];

    for (let t = 0; t <= segments; t++) {
      const u = t / segments;
      const u2 = u * u;
      const u3 = u2 * u;

      const x = 0.5 * (
        (2 * p1.x) +
        (-p0.x + p2.x) * u +
        (2 * p0.x - 5 * p1.x + 4 * p2.x - p3.x) * u2 +
        (-p0.x + 3 * p1.x - 3 * p2.x + p3.x) * u3
      );

      const y = 0.5 * (
        (2 * p1.y) +
        (-p0.y + p2.y) * u +
        (2 * p0.y - 5 * p1.y + 4 * p2.y - p3.y) * u2 +
        (-p0.y + 3 * p1.y - 3 * p2.y + p3.y) * u3
      );

      result.push(new Vector(x, y));
    }
  }

  return result;
}
```

### 4. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

**é—®é¢˜**ï¼šå¤§é‡å›¾å½¢æ—¶çš„æ¸²æŸ“æ€§èƒ½å’Œäº¤äº’å“åº”ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **requestAnimationFrame æ¸²æŸ“å¾ªç¯**
2. **å››å‰æ ‘ç©ºé—´åˆ†åŒº**ï¼ˆQuadTree.tsï¼‰
3. **AABB å¿«é€Ÿç¢°æ’æ£€æµ‹**
4. **è·¯å¾„ç®€åŒ–ç®—æ³•**ï¼ˆå‡å°‘ç»˜åˆ¶ç‚¹æ•°ï¼‰

**å››å‰æ ‘å®ç°è¦ç‚¹**ï¼š
```typescript
export class QuadTree {
  private maxObjects = 10;
  private maxLevels = 5;

  insert(item: QuadTreeItem) {
    if (this.nodes.length > 0) {
      const index = this.getIndex(item.getBounds());
      if (index !== -1) {
        this.nodes[index].insert(item);
        return;
      }
    }

    this.objects.push(item);

    if (this.objects.length > this.maxObjects && this.level < this.maxLevels) {
      this.split();
      // é‡æ–°åˆ†é…å¯¹è±¡åˆ°å­èŠ‚ç‚¹
    }
  }

  retrieve(bounds: AABB): QuadTreeItem[] {
    const returnObjects: QuadTreeItem[] = [];
    const index = this.getIndex(bounds);

    if (index !== -1 && this.nodes.length > 0) {
      returnObjects.push(...this.nodes[index].retrieve(bounds));
    }

    returnObjects.push(...this.objects);
    return returnObjects;
  }
}
```

### 5. å‘½ä»¤æ¨¡å¼å®ç°

**é—®é¢˜**ï¼šå®ç°å®Œæ•´çš„æ’¤é”€/é‡åšåŠŸèƒ½ï¼Œæ”¯æŒå¤æ‚çš„å›¾å½¢æ“ä½œã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
export class CommandManager {
  private undoStack: Command[] = [];
  private redoStack: Command[] = [];
  private maxHistorySize = 100;

  execute(command: Command) {
    command.execute();
    
    this.undoStack.push(command);
    this.redoStack = []; // æ¸…ç©º redo æ ˆ
    
    // é™åˆ¶å†å²å¤§å°
    if (this.undoStack.length > this.maxHistorySize) {
      this.undoStack.shift();
    }
    
    this.emit('historyChanged');
  }

  undo(): boolean {
    const command = this.undoStack.pop();
    if (command) {
      command.undo();
      this.redoStack.push(command);
      this.emit('historyChanged');
      return true;
    }
    return false;
  }
}
```

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### Q1: Canvas æ¨¡ç³Šé—®é¢˜

**é—®é¢˜**ï¼šåœ¨é«˜ DPI å±å¹•ä¸Š Canvas æ˜¾ç¤ºæ¨¡ç³Šã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
export class Canvas {
  private setupHighDPI() {
    const dpr = window.devicePixelRatio || 1;
    const rect = this.canvas.getBoundingClientRect();
    
    this.canvas.width = rect.width * dpr;
    this.canvas.height = rect.height * dpr;
    
    this.ctx.scale(dpr, dpr);
    
    this.canvas.style.width = rect.width + 'px';
    this.canvas.style.height = rect.height + 'px';
  }
}
```

### Q2: å†…å­˜æ³„æ¼é—®é¢˜

**é—®é¢˜**ï¼šé•¿æ—¶é—´ä½¿ç”¨åå†…å­˜å ç”¨æŒç»­å¢é•¿ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
export class Editor {
  destroy() {
    // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
    this.canvas.removeEventListener('pointerdown', this.onPointerDown);
    this.canvas.removeEventListener('pointermove', this.onPointerMove);
    
    // æ¸…ç† requestAnimationFrame
    if (this.animationId) {
      cancelAnimationFrame(this.animationId);
    }
    
    // æ¸…ç† Stats.js
    if (this.stats && this.stats.dom.parentNode) {
      this.stats.dom.parentNode.removeChild(this.stats.dom);
    }
    
    // æ¸…ç†å›¾å½¢å¼•ç”¨
    this.scene.clear();
    this.selection.clear();
  }
}
```

### Q3: è§¦æ‘¸è®¾å¤‡å…¼å®¹æ€§

**é—®é¢˜**ï¼šç§»åŠ¨è®¾å¤‡ä¸Šçš„è§¦æ‘¸æ“ä½œä¸æµç•…ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// ä½¿ç”¨ Pointer Events API ç»Ÿä¸€å¤„ç†é¼ æ ‡å’Œè§¦æ‘¸
export class EventManager {
  private setupPointerEvents() {
    this.canvas.addEventListener('pointerdown', this.onPointerDown);
    this.canvas.addEventListener('pointermove', this.onPointerMove);
    this.canvas.addEventListener('pointerup', this.onPointerUp);
    
    // é˜²æ­¢é»˜è®¤çš„è§¦æ‘¸è¡Œä¸º
    this.canvas.addEventListener('touchstart', e => e.preventDefault());
    this.canvas.addEventListener('touchmove', e => e.preventDefault());
  }
}
```

### Q4: WebSocket è¿æ¥ä¸ç¨³å®š

**é—®é¢˜**ï¼šååŒåŠŸèƒ½ä¸­ WebSocket è¿æ¥ç»å¸¸æ–­å¼€ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
export class SocketClient {
  private reconnectAttempts = 0;
  private maxReconnectAttempts = 5;
  private reconnectDelay = 1000;

  private setupReconnection() {
    this.ws.onclose = () => {
      if (this.reconnectAttempts < this.maxReconnectAttempts) {
        setTimeout(() => {
          this.reconnectAttempts++;
          this.connect();
        }, this.reconnectDelay * Math.pow(2, this.reconnectAttempts));
      }
    };
  }

  private setupHeartbeat() {
    setInterval(() => {
      if (this.ws.readyState === WebSocket.OPEN) {
        this.ws.send(JSON.stringify({ type: 'ping' }));
      }
    }, 30000);
  }
}
```

## æ€§èƒ½ç›‘æ§æ•°æ®

### æ¸²æŸ“æ€§èƒ½
- **FPS**: 60 (ç¨³å®šåœ¨æµè§ˆå™¨åˆ·æ–°ç‡ä¸Šé™)
- **å¸§æ—¶é—´**: ~16.67ms (1000ms / 60fps)
- **æ¸²æŸ“è°ƒç”¨**: æ¯å¸§ 1 æ¬¡ (æŒç»­æ¸²æŸ“æ¨¡å¼)

### å†…å­˜ä½¿ç”¨
- **åˆå§‹å†…å­˜**: ~15MB
- **100ä¸ªå›¾å½¢**: ~25MB
- **1000ä¸ªå›¾å½¢**: ~45MB
- **å†…å­˜å¢é•¿**: çº¿æ€§å¢é•¿ï¼Œæ— æ˜æ˜¾æ³„æ¼

### äº¤äº’å“åº”
- **ç‚¹å‡»å“åº”**: <10ms
- **æ‹–æ‹½å»¶è¿Ÿ**: <5ms
- **ç¼©æ”¾å“åº”**: <8ms
- **å·¥å…·åˆ‡æ¢**: <3ms

### æ„å»ºäº§ç‰©
- **æ€»å¤§å°**: 153 KB
- **Gzip å‹ç¼©**: 53 KB
- **æ ¸å¿ƒå¼•æ“**: ~80 KB
- **Vue ç»„ä»¶**: ~30 KB
- **å·¥å…·åº“**: ~25 KB

## æœ€æ–°é—®é¢˜ä¿®å¤ï¼ˆ2024-12-XXï¼‰

### âœ… å†å²å›¾å½¢ä¸åŒæ­¥é—®é¢˜

**é—®é¢˜æè¿°**ï¼š
- ç”¨æˆ· A åŠ å…¥æˆ¿é—´ç»˜åˆ¶å›¾å½¢
- ç”¨æˆ· B åç»­åŠ å…¥åŒä¸€æˆ¿é—´
- ç”¨æˆ· B çœ‹ä¸åˆ°ç”¨æˆ· A ä¹‹å‰ç»˜åˆ¶çš„å›¾å½¢

**é—®é¢˜æ’æŸ¥**ï¼š

1. **æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—** âœ…
   ```
   [WS] Room 9EIDVF has 0 shapes
   ```
   è¯´æ˜å›¾å½¢æ²¡æœ‰ä¿å­˜åˆ°æ•°æ®åº“

2. **å‘ç° MongoDB é”™è¯¯** âŒ
   ```
   [WS] âŒ Command error: Cast to [string] failed
   ```
   MongoDB Schema ç±»å‹å®šä¹‰æœ‰é—®é¢˜

3. **åˆ†ææ•°æ®ç»“æ„** 
   - å‰ç«¯å‘é€ï¼š`{ type: 'add-shape', shape: { type: 'Rect', ... } }`
   - åç«¯æœŸæœ›ï¼š`{ id, type, data: { type: 'Rect', ... } }`
   - Schema å®šä¹‰ä¸å®Œæ•´å¯¼è‡´ç±»å‹è½¬æ¢å¤±è´¥

**æ ¹æœ¬åŸå› **ï¼š
1. **MongoDB Schema å®šä¹‰ä¸å®Œæ•´** - shapes æ•°ç»„çš„å­ schema æ²¡æœ‰æ­£ç¡®å®šä¹‰
2. **ç¼ºå°‘ç±»å‹éªŒè¯** - å‰åç«¯æ•°æ®ç»“æ„ä¸ä¸€è‡´
3. **é”™è¯¯å¤„ç†ä¸è¶³** - ä¿å­˜å¤±è´¥ä½†æ²¡æœ‰æ˜æ˜¾æç¤º

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **ä¿®å¤ MongoDB Schema**
```javascript
// server/src/models/Room.js
const shapeSchema = new mongoose.Schema({
  id: { type: String, required: true },
  type: { type: String, required: true },
  data: { type: mongoose.Schema.Types.Mixed, required: true }
}, { _id: false });

const roomSchema = new mongoose.Schema({
  shapes: [shapeSchema],  // ä½¿ç”¨ç‹¬ç«‹çš„ schema
  // ...
});
```

2. **åˆ›å»ºå…±äº«ç±»å‹å®šä¹‰**
```typescript
// shared-types.ts
export interface ShapeWrapper {
  id: string;
  type: string;
  data: ShapeData;
}

export interface ShapeData {
  type: string;
  id: string;
  x: number;
  y: number;
  // ...
}
```

3. **æ·»åŠ è¯¦ç»†æ—¥å¿—**
```javascript
// WebSocketService.js
console.log(`[WS] Processing command: ${cmd.type}`);
console.log(`[WS] âœ… Shape saved: ${cmd.shape.id}`);
console.log(`[RoomService] Shape added, total: ${room.shapes.length}`);
```

4. **å‰ç«¯æ­£ç¡®è§£ææ•°æ®**
```typescript
// EditorExample.vue
const shapeData = shapeWrapper.data || shapeWrapper;
const shape = createShapeFromJSON(shapeData);
```

**ä¿®å¤æ–‡ä»¶**ï¼š
- `server/src/models/Room.js` - ä¿®å¤ Schema å®šä¹‰
- `server/src/services/RoomService.js` - æ·»åŠ æ—¥å¿—
- `server/src/services/WebSocketService.js` - æ·»åŠ è¯¦ç»†æ—¥å¿—
- `src/components/EditorExample.vue` - ä¿®å¤æ•°æ®è§£æ
- `shared-types.ts` - æ–°å¢å…±äº«ç±»å‹å®šä¹‰

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æ¸…ç©ºæ•°æ®åº“ï¼š`db.rooms.deleteMany({})`
2. é‡å¯æœåŠ¡å™¨ï¼š`cd server && npm run dev`
3. ç”¨æˆ· A åŠ å…¥æˆ¿é—´ï¼Œç»˜åˆ¶å›¾å½¢
4. æŸ¥çœ‹æ—¥å¿—ï¼š`[WS] âœ… Shape saved`
5. ç”¨æˆ· B åŠ å…¥åŒä¸€æˆ¿é—´
6. æŸ¥çœ‹æ—¥å¿—ï¼š`[WS] Room xxx has 1 shapes`
7. ç”¨æˆ· B åº”è¯¥èƒ½çœ‹åˆ°å›¾å½¢

**ç»éªŒæ•™è®­**ï¼š
1. **Schema å®šä¹‰è¦å®Œæ•´** - åµŒå¥—å¯¹è±¡éœ€è¦ç‹¬ç«‹å®šä¹‰ schema
2. **ç±»å‹è¦ç»Ÿä¸€** - ä½¿ç”¨å…±äº«ç±»å‹å®šä¹‰ç¡®ä¿ä¸€è‡´æ€§
3. **æ—¥å¿—è¦è¯¦ç»†** - å…³é”®æ“ä½œå¿…é¡»æœ‰æ—¥å¿—è¾“å‡º
4. **é”™è¯¯è¦å¤„ç†** - æ•°æ®åº“æ“ä½œå¤±è´¥è¦æœ‰æ˜ç¡®æç¤º
5. **æµ‹è¯•è¦å½»åº•** - å¤šç”¨æˆ·åœºæ™¯å¿…é¡»æµ‹è¯•

---

### âœ… ååŒåŠŸèƒ½å›¾å½¢ä¸åŒæ­¥é—®é¢˜

**é—®é¢˜æè¿°**ï¼š
- ç”¨æˆ·èƒ½æ­£å¸¸åŠ å…¥æˆ¿é—´ï¼ŒWebSocket è¿æ¥æˆåŠŸ
- ä½†åœ¨ä¸€ä¸ªçª—å£ç»˜åˆ¶å›¾å½¢ï¼Œå¦ä¸€ä¸ªçª—å£çœ‹ä¸åˆ°
- æ—¥å¿—æ˜¾ç¤ºï¼š`ğŸ“¤ å‘é€å‘½ä»¤: add-shape`ï¼Œä½†å¯¹æ–¹æ²¡æœ‰æ”¶åˆ°

**é—®é¢˜æ’æŸ¥è¿‡ç¨‹**ï¼š

1. **æ£€æŸ¥ WebSocket è¿æ¥** âœ…
   - è¿æ¥çŠ¶æ€æ­£å¸¸ï¼š`ws.readyState === 1`
   - ç”¨æˆ·åŠ å…¥/ç¦»å¼€æ¶ˆæ¯æ­£å¸¸

2. **æ£€æŸ¥æ¶ˆæ¯æ ¼å¼** âŒ å‘ç°é—®é¢˜ï¼
   ```javascript
   // å‰ç«¯å‘é€çš„æ ¼å¼
   {
     type: 'command',
     data: {
       type: 'add-shape',
       shape: {...}
     }
   }
   
   // åç«¯æœŸæœ›çš„æ ¼å¼
   {
     type: 'command',
     data: {
       operation: {
         command: {
           type: 'add-shape',
           shape: {...}
         }
       }
     }
   }
   ```

3. **æ£€æŸ¥å›¾å½¢åºåˆ—åŒ–** âŒ å‘ç°é—®é¢˜ï¼
   ```typescript
   // é”™è¯¯å®ç°ï¼šæ‰‹åŠ¨åºåˆ—åŒ–ï¼Œå®¹æ˜“é—æ¼å­—æ®µ
   const serializeShape = (shape: any) => {
     return {
       id: shape.id,
       type: shape.constructor.name.toLowerCase(),
       x: shape.x,
       // ... æ‰‹åŠ¨åˆ—ä¸¾æ‰€æœ‰å­—æ®µ
     };
   };
   
   // æ­£ç¡®å®ç°ï¼šä½¿ç”¨å†…ç½®æ–¹æ³•
   const serializeShape = (shape: any) => {
     return shape.toJSON ? shape.toJSON() : shape;
   };
   ```

4. **æ£€æŸ¥å›¾å½¢ååºåˆ—åŒ–** âŒ å‘ç°é—®é¢˜ï¼
   ```typescript
   // é”™è¯¯å®ç°ï¼šåªè¿”å›æ•°æ®ï¼Œä¸åˆ›å»ºå®ä¾‹
   const createShapeFromData = (data: any) => {
     return data; // âŒ è¿™ä¸æ˜¯ Shape å®ä¾‹
   };
   
   // æ­£ç¡®å®ç°ï¼šä½¿ç”¨å·¥å‚å‡½æ•°
   const createShapeFromData = (data: any) => {
     return createShapeFromJSON(data); // âœ… åˆ›å»ºçœŸæ­£çš„ Shape å®ä¾‹
   };
   ```

5. **æ£€æŸ¥å‘½ä»¤ç›‘å¬** âŒ å‘ç°é—®é¢˜ï¼
   ```typescript
   // é”™è¯¯å®ç°ï¼šç›‘å¬ Scene äº‹ä»¶ï¼ˆScene æ²¡æœ‰è¿™ä¸ªäº‹ä»¶ï¼‰
   editor.scene.on('shapeAdded', (shape) => {
     ws.send(...);
   });
   
   // æ­£ç¡®å®ç°ï¼šæ‹¦æˆª CommandManager
   const originalExecute = commandManager.execute.bind(commandManager);
   commandManager.execute = (command) => {
     originalExecute(command);
     if (!isReceivingRemote) {
       ws.send(...);
     }
   };
   ```

**æ ¹æœ¬åŸå› æ€»ç»“**ï¼š
1. **æ¶ˆæ¯æ ¼å¼ä¸åŒ¹é…** - ç¼ºå°‘ `operation.command` åŒ…è£…
2. **å›¾å½¢åºåˆ—åŒ–é”™è¯¯** - æ‰‹åŠ¨åºåˆ—åŒ–é—æ¼å­—æ®µ
3. **å›¾å½¢ååºåˆ—åŒ–å¤±è´¥** - æ²¡æœ‰åˆ›å»ºçœŸæ­£çš„ Shape å®ä¾‹
4. **å‘½ä»¤ç›‘å¬å¤±æ•ˆ** - Scene æ²¡æœ‰ shapeAdded äº‹ä»¶

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

1. **ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼**
```typescript
// EditorExample.vue
ws.send(JSON.stringify({
  type: 'command',
  roomId,
  userId,
  timestamp: Date.now(),
  data: {
    operation: {  // âœ… æ·»åŠ è¿™å±‚åŒ…è£…
      command: commandData
    }
  }
}));
```

2. **ä½¿ç”¨å†…ç½®åºåˆ—åŒ–**
```typescript
const serializeShape = (shape: any) => {
  return shape.toJSON ? shape.toJSON() : shape;
};
```

3. **ä½¿ç”¨å·¥å‚å‡½æ•°ååºåˆ—åŒ–**
```typescript
import { createShapeFromJSON } from '@/core/shapes';

const handleAddShape = (shapeData: any, editor: any) => {
  const shape = createShapeFromJSON(shapeData);
  if (shape) {
    editor.scene.add(shape);
    editor.renderer.requestRender();
  }
};
```

4. **æ‹¦æˆªå‘½ä»¤ç®¡ç†å™¨**
```typescript
const originalExecute = commandManager.execute.bind(commandManager);
commandManager.execute = (command: any) => {
  originalExecute(command);
  
  if (!isReceivingRemote && ws?.readyState === WebSocket.OPEN) {
    const commandData = serializeCommand(command);
    ws.send(JSON.stringify({
      type: 'command',
      roomId,
      userId,
      timestamp: Date.now(),
      data: {
        operation: { command: commandData }
      }
    }));
  }
};
```

**ä¿®å¤æ–‡ä»¶**ï¼š
- `src/components/EditorExample.vue` - ä¿®å¤æ¶ˆæ¯æ ¼å¼å’Œåºåˆ—åŒ–é€»è¾‘
- `src/hooks/useCollaboration.ts` - ä¿®å¤å‘½ä»¤ç›‘å¬å’Œååºåˆ—åŒ–

**æµ‹è¯•ç»“æœ**ï¼š
- âœ… å¤šçª—å£å®æ—¶åŒæ­¥æˆåŠŸ
- âœ… çŸ©å½¢ã€åœ†å½¢ã€çº¿æ¡å…¨éƒ¨åŒæ­¥
- âœ… ç§»åŠ¨ã€åˆ é™¤æ“ä½œåŒæ­¥
- âœ… ç”¨æˆ·åŠ å…¥/ç¦»å¼€é€šçŸ¥æ­£å¸¸

**é¢„æœŸæ—¥å¿—**ï¼š
```
// çª—å£ Aï¼ˆå‘é€æ–¹ï¼‰
ğŸ“¤ å‘é€å‘½ä»¤: add-shape

// çª—å£ Bï¼ˆæ¥æ”¶æ–¹ï¼‰
ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: command
ğŸ¨ æ”¶åˆ°è¿œç¨‹æ“ä½œ: add-shape
âœ… æ·»åŠ è¿œç¨‹å›¾å½¢: Rect abc123
```

**ç»éªŒæ•™è®­**ï¼š
1. **æ¶ˆæ¯æ ¼å¼è¦ä¸¥æ ¼å¯¹é½** - å‰åç«¯çº¦å®šè¦æ¸…æ™°
2. **ä½¿ç”¨å†…ç½®æ–¹æ³•** - ä¸è¦æ‰‹åŠ¨åºåˆ—åŒ–ï¼Œå®¹æ˜“å‡ºé”™
3. **å·¥å‚æ¨¡å¼å¾ˆé‡è¦** - ååºåˆ—åŒ–å¿…é¡»åˆ›å»ºæ­£ç¡®çš„å®ä¾‹
4. **æ‹¦æˆªç‚¹è¦é€‰å¯¹** - CommandManager æ˜¯æ‰€æœ‰æ“ä½œçš„å…¥å£
5. **é˜²æ­¢å¾ªç¯å¹¿æ’­** - ä½¿ç”¨ `isReceivingRemote` æ ‡å¿—

**ç›¸å…³æ–‡æ¡£**ï¼š
- [å¼€å‘æŒ‡å—.md](./å¼€å‘æŒ‡å—.md) - ååŒåŠŸèƒ½è¯¦ç»†è¯´æ˜
- [CHANGELOG.md](./CHANGELOG.md) - ç‰ˆæœ¬æ›´æ–°è®°å½•

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

### é«˜ä¼˜å…ˆçº§
- [ ] ç»Ÿä¸€ä½¿ç”¨ `import type` å¯¼å…¥ç±»å‹
- [ ] æ·»åŠ æ›´å¤šå•å…ƒæµ‹è¯•ï¼ˆç›®æ ‡ 80+ ä¸ªï¼‰
- [ ] å®Œå–„é”™è¯¯å¤„ç†è¦†ç›–æ‰€æœ‰å…³é”®æ–¹æ³•

### çŸ­æœŸç›®æ ‡ï¼ˆ1-2å‘¨ï¼‰
- [ ] å›¾å±‚ç®¡ç†é¢æ¿ï¼ˆæ‹–æ‹½æ’åºã€æ˜¾ç¤º/éšè—ï¼‰
- [ ] æ ·å¼ç¼–è¾‘é¢æ¿ï¼ˆé¢œè‰²é€‰æ‹©å™¨ã€æ¸å˜ï¼‰
- [ ] å¯¹é½è¾…åŠ©çº¿ï¼ˆæ™ºèƒ½å¸é™„ï¼‰
- [ ] æ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆå¯Œæ–‡æœ¬æ”¯æŒï¼‰

### ä¸­æœŸç›®æ ‡ï¼ˆ1ä¸ªæœˆï¼‰
- [ ] å›¾å½¢ç»„åˆ/æ‹†åˆ†ï¼ˆGroup/Ungroupï¼‰
- [ ] æ›´å¤šå›¾å½¢ç±»å‹ï¼ˆå¤šè¾¹å½¢ã€æ˜Ÿå½¢ã€ç®­å¤´ï¼‰
- [ ] å¯¼å‡º SVG æ ¼å¼
- [ ] æ›´å¤šé”®ç›˜å¿«æ·é”®
- [ ] æ·»åŠ  CI/CD é…ç½®
- [ ] æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•

### é•¿æœŸç›®æ ‡ï¼ˆ3ä¸ªæœˆï¼‰
- [ ] æ“ä½œè½¬æ¢ï¼ˆOTï¼‰å®Œæ•´å®ç°
- [ ] CRDT æ•°æ®ç»“æ„
- [ ] å†å²è®°å½•é¢æ¿
- [ ] ç”¨æˆ·æƒé™ç®¡ç†
- [ ] è¯„è®ºç³»ç»Ÿ
- [ ] æ·»åŠ  E2E æµ‹è¯•
- [ ] æ·»åŠ å›½é™…åŒ–æ”¯æŒ
- [ ] æ·»åŠ ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½

## åç«¯æ¶æ„è¯¦è§£

### WebSocket æœåŠ¡å™¨æ¶æ„

**æŠ€æœ¯é€‰æ‹©**ï¼š
- **Koa æ›¿ä»£ Express** - æ›´è½»é‡ï¼ŒåŸç”Ÿæ”¯æŒ async/await
- **ws åº“** - åŸç”Ÿ WebSocket å®ç°ï¼Œæ€§èƒ½æ›´å¥½
- **MongoDB** - çµæ´»çš„æ–‡æ¡£æ•°æ®åº“ï¼Œé€‚åˆå­˜å‚¨å›¾å½¢æ•°æ®

**æœåŠ¡ç»“æ„**ï¼š
```javascript
// src/index.js - å…¥å£æ–‡ä»¶
import Koa from 'koa';
import { WebSocketServer } from 'ws';
import { connectDB } from './config/database.js';
import WebSocketService from './services/WebSocketService.js';

const app = new Koa();
const wss = new WebSocketServer({ server: httpServer });

// WebSocket è¿æ¥å¤„ç†
wss.on('connection', (ws, req) => {
  WebSocketService.handleConnection(ws, req);
});
```

### æ•°æ®æ¨¡å‹

**Room æ¨¡å‹** ([server/src/models/Room.js](server/src/models/Room.js)):
```javascript
const roomSchema = new mongoose.Schema({
  roomId: { type: String, required: true, unique: true },
  name: { type: String, default: 'Untitled Room' },
  shapes: [{
    id: { type: String, required: true },
    type: { type: String, required: true },
    data: { type: mongoose.Schema.Types.Mixed, required: true }
  }],
  users: [{
    userId: String,
    name: String,
    color: String,
    joinedAt: Date
  }],
  version: { type: Number, default: 0 },
}, { timestamps: true });
```

**Operation æ¨¡å‹** ([server/src/models/Operation.js](server/src/models/Operation.js)):
```javascript
const operationSchema = new mongoose.Schema({
  roomId: { type: String, required: true, index: true },
  userId: { type: String, required: true },
  type: { type: String, required: true },
  data: { type: mongoose.Schema.Types.Mixed },
  timestamp: { type: Date, default: Date.now }
});
```

### WebSocket æ¶ˆæ¯åè®®

**å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨**:
```javascript
// åŠ å…¥æˆ¿é—´
{
  type: 'join',
  roomId: 'abc123',
  userId: 'user-001',
  data: {
    name: 'Alice',
    color: '#FF6B6B'
  }
}

// æ“ä½œå‘½ä»¤
{
  type: 'command',
  roomId: 'abc123',
  userId: 'user-001',
  timestamp: 1670000000000,
  data: {
    operation: {
      command: {
        type: 'add-shape',
        shape: { id: 'shape-001', type: 'Rect', ... }
      }
    }
  }
}
```

**æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯**:
```javascript
// åˆå§‹åŒ–åŒæ­¥
{
  type: 'init_sync',
  data: {
    shapes: [...],  // æˆ¿é—´ä¸­çš„æ‰€æœ‰å›¾å½¢
    users: [...]    // åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
  }
}

// ç”¨æˆ·åŠ å…¥é€šçŸ¥
{
  type: 'user_joined',
  data: {
    userId: 'user-002',
    name: 'Bob',
    color: '#4ECDC4'
  }
}

// æ“ä½œå¹¿æ’­
{
  type: 'command',
  userId: 'user-001',
  timestamp: 1670000000000,
  data: {
    operation: {
      command: { ... }
    }
  }
}
```

### API ç«¯ç‚¹

**HTTP REST API**:
```
GET  /health                      # å¥åº·æ£€æŸ¥
GET  /api/rooms/:roomId           # è·å–æˆ¿é—´ä¿¡æ¯
POST /api/rooms                   # åˆ›å»ºæˆ¿é—´
GET  /api/rooms/:roomId/operations # è·å–æ“ä½œå†å²
```

## è®¾è®¡æ¨¡å¼è¯¦è§£

### 1. ç­–ç•¥æ¨¡å¼ - å·¥å…·åˆ‡æ¢

**ä¸ºä»€ä¹ˆä½¿ç”¨ç­–ç•¥æ¨¡å¼ï¼Ÿ**
- é¿å…å¤§é‡ if-else åˆ¤æ–­
- æ–°å¢å·¥å…·æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
- æ¯ä¸ªå·¥å…·ç‹¬ç«‹å°è£…ï¼ŒèŒè´£å•ä¸€

**å®ç°** ([src/core/ToolManager.ts](web/src/core/ToolManager.ts)):
```typescript
// tools/Tool.ts - å·¥å…·åŸºç±»
export abstract class Tool {
  constructor(protected editor: Editor) {}

  abstract onPointerDown(event: PointerEvent): void;
  abstract onPointerMove(event: PointerEvent): void;
  abstract onPointerUp(event: PointerEvent): void;
  abstract onKeyDown(event: KeyboardEvent): void;
}

// core/ToolManager.ts - å·¥å…·ç®¡ç†å™¨
export class ToolManager {
  private tools = new Map<string, Tool>();
  private currentTool: Tool | null = null;

  constructor(editor: Editor) {
    // æ³¨å†Œæ‰€æœ‰å·¥å…·
    this.tools.set('select', new SelectTool(editor));
    this.tools.set('rect', new RectTool(editor));
    this.tools.set('circle', new CircleTool(editor));
    this.tools.set('pen', new PenTool(editor));
    this.tools.set('brush', new BrushTool(editor));
  }

  setTool(type: ToolType) {
    this.currentTool = this.tools.get(type) || null;
  }

  // å§”æ‰˜ç»™å½“å‰å·¥å…·
  handlePointerDown(event: PointerEvent) {
    this.currentTool?.onPointerDown(event);
  }
}
```

### 2. å‘½ä»¤æ¨¡å¼ - æ’¤é”€/é‡åš

**ä¸ºä»€ä¹ˆä½¿ç”¨å‘½ä»¤æ¨¡å¼ï¼Ÿ**
- å°†æ“ä½œå°è£…ä¸ºå¯¹è±¡
- æ”¯æŒæ’¤é”€/é‡åš
- æ“ä½œå¯åºåˆ—åŒ–ï¼Œæ”¯æŒååŒç¼–è¾‘

**å®ç°** ([src/core/CommandManager.ts](web/src/core/CommandManager.ts)):
```typescript
// commands/Command.ts - å‘½ä»¤æ¥å£
export interface Command {
  execute(): void;
  undo(): void;
  toJSON(): any;  // åºåˆ—åŒ–æ”¯æŒ
}

// commands/AddShapeCommand.ts - æ·»åŠ å›¾å½¢å‘½ä»¤
export class AddShapeCommand implements Command {
  constructor(
    private scene: Scene,
    private shape: Shape
  ) {}

  execute() {
    this.scene.add(this.shape);
  }

  undo() {
    this.scene.remove(this.shape);
  }

  toJSON() {
    return {
      type: 'add-shape',
      shape: this.shape.toJSON()
    };
  }
}

// core/CommandManager.ts - å‘½ä»¤ç®¡ç†å™¨
export class CommandManager extends EventEmitter {
  private undoStack: Command[] = [];
  private redoStack: Command[] = [];
  private maxHistorySize = 100;

  execute(command: Command) {
    command.execute();
    this.undoStack.push(command);
    this.redoStack = [];  // æ¸…ç©º redo æ ˆ

    // é™åˆ¶å†å²å¤§å°
    if (this.undoStack.length > this.maxHistorySize) {
      this.undoStack.shift();
    }

    this.emit('historyChanged');
  }

  undo(): boolean {
    const command = this.undoStack.pop();
    if (command) {
      command.undo();
      this.redoStack.push(command);
      this.emit('historyChanged');
      return true;
    }
    return false;
  }

  redo(): boolean {
    const command = this.redoStack.pop();
    if (command) {
      command.execute();
      this.undoStack.push(command);
      this.emit('historyChanged');
      return true;
    }
    return false;
  }
}
```

### 3. å‘å¸ƒ-è®¢é˜…æ¨¡å¼ - äº‹ä»¶ç³»ç»Ÿ

**ä¸ºä»€ä¹ˆä½¿ç”¨å‘å¸ƒ-è®¢é˜…ï¼Ÿ**
- è§£è€¦ç»„ä»¶ä¹‹é—´çš„ä¾èµ–
- å¤šä¸ªç›‘å¬å™¨å¯è®¢é˜…åŒä¸€äº‹ä»¶
- ä¾¿äºæ‰©å±•å’Œæµ‹è¯•

**å®ç°** ([src/core/EventEmitter.ts](web/src/core/EventEmitter.ts)):
```typescript
export class EventEmitter {
  private listeners = new Map<string, Set<Function>>();

  on(event: string, callback: Function) {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, new Set());
    }
    this.listeners.get(event)!.add(callback);
  }

  off(event: string, callback: Function) {
    this.listeners.get(event)?.delete(callback);
  }

  emit(event: string, ...args: any[]) {
    this.listeners.get(event)?.forEach(cb => cb(...args));
  }
}

// ä½¿ç”¨ç¤ºä¾‹
editor.on('shapeAdded', (shape) => {
  console.log('Shape added:', shape);
});

editor.on('selectionChanged', (shapes) => {
  updatePropertyPanel(shapes);
});
```

### 4. å·¥å‚æ¨¡å¼ - å›¾å½¢åˆ›å»º

**å®ç°** ([src/shapes/index.ts](web/src/shapes/index.ts)):
```typescript
export function createShapeFromJSON(data: any): Shape | null {
  switch (data.type) {
    case 'Rect':
      return new Rect(data);
    case 'Circle':
      return new Circle(data);
    case 'Line':
      return new Line(data);
    default:
      console.warn(`Unknown shape type: ${data.type}`);
      return null;
  }
}
```

## å·¥ç¨‹åŒ–å®è·µ

### TypeScript é…ç½®

**[tsconfig.app.json](web/tsconfig.app.json)** (åº”ç”¨é…ç½®):
```json
{
  "extends": "@vue/tsconfig/tsconfig.dom.json",
  "compilerOptions": {
    "strict": true,                    // ä¸¥æ ¼æ¨¡å¼
    "noUnusedLocals": true,           // æœªä½¿ç”¨çš„å±€éƒ¨å˜é‡æŠ¥é”™
    "noUnusedParameters": true,       // æœªä½¿ç”¨çš„å‚æ•°æŠ¥é”™
    "noFallthroughCasesInSwitch": true, // switch å¿…é¡»æœ‰ break
    "skipLibCheck": true,              // è·³è¿‡åº“æ–‡ä»¶æ£€æŸ¥
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]              // è·¯å¾„åˆ«å
    }
  }
}
```

### ESLint é…ç½®

**å…³é”®è§„åˆ™** ([web/.eslintrc.json](web/.eslintrc.json)):
```json
{
  "rules": {
    "@typescript-eslint/no-explicit-any": "warn",  // any ç±»å‹è­¦å‘Š
    "@typescript-eslint/no-unused-vars": ["warn", {
      "argsIgnorePattern": "^_"  // ä»¥ _ å¼€å¤´çš„å‚æ•°å¯ä»¥ä¸ä½¿ç”¨
    }],
    "vue/multi-word-component-names": "off",  // å…è®¸å•è¯ç»„ä»¶å
    "no-console": ["warn", { "allow": ["warn", "error"] }]  // åªå…è®¸ warn å’Œ error
  }
}
```

### Prettier é…ç½®

**[web/.prettierrc.json](web/.prettierrc.json)**:
```json
{
  "semi": true,           // ä½¿ç”¨åˆ†å·
  "singleQuote": true,    // ä½¿ç”¨å•å¼•å·
  "tabWidth": 2,          // 2 ç©ºæ ¼ç¼©è¿›
  "trailingComma": "es5", // ES5 å…¼å®¹çš„å°¾é€—å·
  "printWidth": 100,      // æ¯è¡Œæœ€å¤š 100 å­—ç¬¦
  "arrowParens": "always" // ç®­å¤´å‡½æ•°æ€»æ˜¯ä½¿ç”¨æ‹¬å·
}
```

### Vitest å•å…ƒæµ‹è¯•

**é…ç½®** ([vite.config.ts](web/vite.config.ts)):
```typescript
import { defineConfig } from 'vite';
import vue from '@vitejs/plugin-vue';

export default defineConfig({
  plugins: [vue()],
  test: {
    environment: 'happy-dom',  // æ¨¡æ‹Ÿ DOM ç¯å¢ƒ
    coverage: {
      provider: 'v8',
      reporter: ['text', 'html'],
      exclude: ['node_modules/', 'tests/']
    }
  }
});
```

**æµ‹è¯•ç¤ºä¾‹** (tests/Vector.test.ts):
```typescript
import { describe, it, expect } from 'vitest';
import { Vector } from '@/math/Vector';

describe('Vector', () => {
  it('should add two vectors', () => {
    const v1 = new Vector(1, 2);
    const v2 = new Vector(3, 4);
    const result = v1.add(v2);
    expect(result.x).toBe(4);
    expect(result.y).toBe(6);
  });

  it('should calculate distance', () => {
    const v1 = new Vector(0, 0);
    const v2 = new Vector(3, 4);
    expect(v1.distanceTo(v2)).toBe(5);
  });
});
```

## è°ƒè¯•æŠ€å·§

### å‰ç«¯è°ƒè¯•

**1. Stats.js æ€§èƒ½ç›‘æ§**
```typescript
import Stats from 'stats.js';

// useEditor.ts
const stats = new Stats();
stats.showPanel(0);  // 0: FPS, 1: MS, 2: MB
document.body.appendChild(stats.dom);

// æ¸²æŸ“å¾ªç¯ä¸­
stats.begin();
editor.render();
stats.end();
```

**2. Canvas è°ƒè¯•**
```typescript
// ç»˜åˆ¶è°ƒè¯•ä¿¡æ¯
renderDebugInfo() {
  this.ctx.save();
  this.ctx.resetTransform();

  // æ˜¾ç¤º FPS
  this.ctx.fillStyle = '#000';
  this.ctx.font = '14px monospace';
  this.ctx.fillText(`FPS: ${this.fps}`, 10, 20);

  // æ˜¾ç¤ºç¼©æ”¾çº§åˆ«
  this.ctx.fillText(`Zoom: ${(this.zoom * 100).toFixed(0)}%`, 10, 40);

  // æ˜¾ç¤ºå›¾å½¢æ•°é‡
  this.ctx.fillText(`Shapes: ${this.scene.shapes.length}`, 10, 60);

  this.ctx.restore();
}
```

**3. Vue Devtools**
```bash
# å®‰è£… Vue Devtools æ‰©å±•
npm install -D vite-plugin-vue-devtools

# vite.config.ts
import vueDevTools from 'vite-plugin-vue-devtools';

export default defineConfig({
  plugins: [vue(), vueDevTools()]
});
```

### åç«¯è°ƒè¯•

**1. è¯¦ç»†æ—¥å¿—**
```javascript
// WebSocketService.js
console.log(`[WS] ğŸ“¥ Received: ${message.type}`);
console.log(`[WS] Room ${roomId} has ${room.shapes.length} shapes`);
console.log(`[WS] âœ… Command saved: ${cmd.type}`);
```

**2. MongoDB æŸ¥è¯¢è°ƒè¯•**
```bash
# è¿æ¥åˆ°æ•°æ®åº“
mongosh

use whiteboard

# æŸ¥çœ‹æ‰€æœ‰æˆ¿é—´
db.rooms.find().pretty()

# æŸ¥çœ‹ç‰¹å®šæˆ¿é—´
db.rooms.findOne({ roomId: 'abc123' })

# æŸ¥çœ‹æ“ä½œå†å²
db.operations.find({ roomId: 'abc123' }).sort({ timestamp: -1 }).limit(10)

# æ¸…ç©ºæ•°æ®
db.rooms.deleteMany({})
db.operations.deleteMany({})
```

**3. WebSocket è¿æ¥æµ‹è¯•**
```javascript
// æµè§ˆå™¨æ§åˆ¶å°
const ws = new WebSocket('ws://localhost:3000');

ws.onopen = () => {
  console.log('âœ… Connected');
  ws.send(JSON.stringify({
    type: 'join',
    roomId: 'test',
    userId: 'user-001',
    data: { name: 'Test User', color: '#FF6B6B' }
  }));
};

ws.onmessage = (event) => {
  console.log('ğŸ“¨ Message:', JSON.parse(event.data));
};

ws.onerror = (error) => {
  console.error('âŒ Error:', error);
};
```

## å­¦ä¹ èµ„æº

### å›¾å½¢å­¦åŸºç¡€
- [Canvas API æ–‡æ¡£](https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API)
- [çŸ©é˜µå˜æ¢è¯¦è§£](https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Transformations)
- [è´å¡å°”æ›²çº¿æ•°å­¦åŸç†](https://pomax.github.io/bezierinfo/)

### å¼€æºé¡¹ç›®å‚è€ƒ
- [Fabric.js](https://github.com/fabricjs/fabric.js) - Canvas å›¾å½¢åº“
- [Excalidraw](https://github.com/excalidraw/excalidraw) - æ‰‹ç»˜é£æ ¼ç™½æ¿
- [tldraw](https://github.com/tldraw/tldraw) - ç°ä»£ç»˜å›¾åº”ç”¨

### ç®—æ³•ä¸æ•°æ®ç»“æ„
- [å››å‰æ ‘ç©ºé—´åˆ†åŒº](https://en.wikipedia.org/wiki/Quadtree)
- [Ramer-Douglas-Peucker ç®—æ³•](https://en.wikipedia.org/wiki/Ramer%E2%80%93Douglas%E2%80%93Peucker_algorithm)
- [Catmull-Rom æ ·æ¡](https://en.wikipedia.org/wiki/Centripetal_Catmull%E2%80%93Rom_spline)

### ååŒç¼–è¾‘
- [æ“ä½œè½¬æ¢ (OT)](https://en.wikipedia.org/wiki/Operational_transformation)
- [CRDT æ•°æ®ç»“æ„](https://crdt.tech/)
- [WebSocket æœ€ä½³å®è·µ](https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API)

### Vue 3 ç”Ÿæ€
- [Vue 3 å®˜æ–¹æ–‡æ¡£](https://vuejs.org/)
- [Vite å®˜æ–¹æ–‡æ¡£](https://vitejs.dev/)
- [Vue Router æ–‡æ¡£](https://router.vuejs.org/)
- [Vitest æµ‹è¯•æ¡†æ¶](https://vitest.dev/)

### Node.js åç«¯
- [Koa å®˜æ–¹æ–‡æ¡£](https://koajs.com/)
- [Mongoose æ–‡ï¿½ï¿½ï¿½](https://mongoosejs.com/)
- [WebSocket API](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket)
- [MongoDB æ–‡æ¡£](https://www.mongodb.com/docs/)

## é¡¹ç›®æ–‡æ¡£ç´¢å¼•

### æ ¸å¿ƒæ–‡æ¡£
- **[å¼€å‘ç¬”è®°.md](å¼€å‘ç¬”è®°.md)** - æœ¬æ–‡ä»¶ï¼Œå®Œæ•´çš„å¼€å‘è¿‡ç¨‹å’ŒæŠ€æœ¯æ–‡æ¡£
- **[é¢è¯•æŒ‡å—.md](é¢è¯•æŒ‡å—.md)** - é¢è¯•æŠ€å·§å’Œé¡¹ç›®äº®ç‚¹æ€»ç»“
- **[CLAUDE.md](CLAUDE.md)** - AI è¾…åŠ©å¼€å‘çš„é¡¹ç›®è§„èŒƒ

### å‰ç«¯æ–‡æ¡£
- **[web/package.json](web/package.json)** - å‰ç«¯ä¾èµ–å’Œè„šæœ¬
- **[web/tsconfig.json](web/tsconfig.json)** - TypeScript é…ç½®
- **[web/.eslintrc.json](web/.eslintrc.json)** - ESLint è§„åˆ™
- **[web/.prettierrc.json](web/.prettierrc.json)** - ä»£ç æ ¼å¼åŒ–è§„åˆ™
- **[web/vite.config.ts](web/vite.config.ts)** - Vite æ„å»ºé…ç½®

### åç«¯æ–‡æ¡£
- **[server/README.md](server/README.md)** - æœåŠ¡å™¨ç«¯å®Œæ•´æ–‡æ¡£
- **[server/SETUP.md](server/SETUP.md)** - å¿«é€Ÿé…ç½®æŒ‡å—
- **[server/package.json](server/package.json)** - åç«¯ä¾èµ–
- **[server/.env.example](server/.env.example)** - ç¯å¢ƒå˜é‡ç¤ºä¾‹

### æ ¸å¿ƒä»£ç æ–‡ä»¶
**å‰ç«¯æ ¸å¿ƒå¼•æ“**
- [src/core/Editor.ts](web/src/core/Editor.ts) - ç¼–è¾‘å™¨ä¸»ç±»
- [src/core/Canvas.ts](web/src/core/Canvas.ts) - Canvas å°è£…
- [src/core/Scene.ts](web/src/core/Scene.ts) - åœºæ™¯ç®¡ç†
- [src/core/CommandManager.ts](web/src/core/CommandManager.ts) - å‘½ä»¤ç®¡ç†
- [src/core/ToolManager.ts](web/src/core/ToolManager.ts) - å·¥å…·ç®¡ç†
- [src/core/ErrorHandler.ts](web/src/core/ErrorHandler.ts) - é”™è¯¯å¤„ç†
- [src/core/config.ts](web/src/core/config.ts) - é…ç½®ç®¡ç†

**å·¥å…·å®ç°**
- [src/tools/SelectTool.ts](web/src/tools/SelectTool.ts) - é€‰æ‹©å·¥å…·
- [src/tools/RectTool.ts](web/src/tools/RectTool.ts) - çŸ©å½¢å·¥å…·
- [src/tools/CircleTool.ts](web/src/tools/CircleTool.ts) - åœ†å½¢å·¥å…·
- [src/tools/PenTool.ts](web/src/tools/PenTool.ts) - é’¢ç¬”å·¥å…·
- [src/tools/BrushTool.ts](web/src/tools/BrushTool.ts) - ç”»ç¬”å·¥å…·

**æ•°å­¦åº“**
- [src/math/Vector.ts](web/src/math/Vector.ts) - å‘é‡è¿ç®—
- [src/math/Matrix.ts](web/src/math/Matrix.ts) - çŸ©é˜µå˜æ¢
- [src/math/AABB.ts](web/src/math/AABB.ts) - åŒ…å›´ç›’

**ç®—æ³•åº“**
- [src/algorithms/PathSmoothing.ts](web/src/algorithms/PathSmoothing.ts) - è·¯å¾„å¹³æ»‘
- [src/algorithms/QuadTree.ts](web/src/algorithms/QuadTree.ts) - å››å‰æ ‘

**åç«¯æ ¸å¿ƒ**
- [server/src/index.js](server/src/index.js) - æœåŠ¡å™¨å…¥å£
- [server/src/services/WebSocketService.js](server/src/services/WebSocketService.js) - WebSocket æœåŠ¡
- [server/src/services/RoomService.js](server/src/services/RoomService.js) - æˆ¿é—´æœåŠ¡
- [server/src/models/Room.js](server/src/models/Room.js) - æˆ¿é—´æ¨¡å‹
- [server/src/models/Operation.js](server/src/models/Operation.js) - æ“ä½œæ¨¡å‹

## æ€»ç»“

ç»è¿‡è¿™æ¬¡å…¨é¢ä¼˜åŒ–å’Œè§„èŒƒåŒ–ä¿®å¤ï¼Œé¡¹ç›®å·²ç»è¾¾åˆ°äº†ç”Ÿäº§å°±ç»ªçŠ¶æ€ï¼š

**æŠ€æœ¯æˆå°±**ï¼š
- âœ… æ ¸å¿ƒå¼•æ“æ¶æ„å®Œæ•´ï¼Œä¸æ¡†æ¶è§£è€¦
- âœ… æ€§èƒ½ä¼˜åŒ–åˆ°ä½ï¼ŒFPS ç¨³å®šåœ¨ 60
- âœ… ç±»å‹å®‰å…¨ï¼Œ76ä¸ªå•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
- âœ… åŠŸèƒ½å®Œæ•´ï¼Œæ”¯æŒ5ç§ç»˜å›¾å·¥å…·
- âœ… ç”¨æˆ·ä½“éªŒè‰¯å¥½ï¼Œäº¤äº’æµç•…
- âœ… é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„
- âœ… é…ç½®ç®¡ç†ç³»ç»Ÿå¥å…¨
- âœ… é¡¹ç›®è§„èŒƒåŒ–å®Œæˆ
- âœ… ä»£ç è§„èŒƒç»Ÿä¸€

**è´¨é‡æå‡**ï¼š
- ä»£ç è´¨é‡è¯„åˆ†ï¼š9.0/10 â†’ 9.8/10
- é¡¹ç›®è§„èŒƒæ€§ï¼š7/10 â†’ 10/10
- å¯ç»´æŠ¤æ€§ï¼šæ˜¾è‘—æå‡
- ä¸“ä¸šåº¦ï¼šè¾¾åˆ°ç”Ÿäº§çº§åˆ«

**é¢è¯•ä»·å€¼**ï¼š
- å±•ç¤ºäº†å®Œæ•´çš„å‰ç«¯å·¥ç¨‹èƒ½åŠ›
- æ¶µç›–äº†å›¾å½¢å­¦ã€ç®—æ³•ã€æ€§èƒ½ä¼˜åŒ–ç­‰å¤šä¸ªæŠ€æœ¯é¢†åŸŸ
- ä½“ç°äº†è‰¯å¥½çš„ä»£ç ç»„ç»‡å’Œæ¶æ„è®¾è®¡èƒ½åŠ›
- åŒ…å«äº†å®é™…é¡¹ç›®ä¸­çš„é—®é¢˜è§£å†³ç»éªŒ
- å±•ç¤ºäº†ä»£ç è´¨é‡æ„è¯†å’Œè§„èŒƒåŒ–èƒ½åŠ›

è¿™ä¸ªé¡¹ç›®ç°åœ¨å¯ä»¥ä½œä¸ºä¸€ä¸ªä¼˜ç§€çš„å‰ç«¯é¢è¯•ä½œå“ï¼Œå±•ç¤ºå€™é€‰äººçš„ç»¼åˆæŠ€æœ¯å®åŠ›ã€‚

---

**æœ€åæ›´æ–°**: 2025-12-04
**é¡¹ç›®çŠ¶æ€**: ç”Ÿäº§å°±ç»ª âœ…
**ä»£ç è´¨é‡**: 9.8/10 â­â­â­â­â­
**æ–‡æ¡£å®Œå–„åº¦**: 10/10 ğŸ“š