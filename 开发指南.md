# å¼€å‘æŒ‡å—

> åˆå¹¶äº†ï¼šååŒåŠŸèƒ½è¯´æ˜ã€ååŒé—®é¢˜ä¿®å¤è¯´æ˜ã€é¡¹ç›®æ•´ç†è¯´æ˜ã€é¡¹ç›®æ–‡ä»¶è¯´æ˜

## ğŸ“‹ ç›®å½•

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [ååŒåŠŸèƒ½è¯´æ˜](#ååŒåŠŸèƒ½è¯´æ˜)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [æœåŠ¡å™¨é€‰æ‹©](#æœåŠ¡å™¨é€‰æ‹©)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šç®€å•ç‰ˆï¼ˆæ¨èï¼‰

```bash
# Windows
start-simple.bat

# Linux/macOS
chmod +x start-simple.sh
./start-simple.sh
```

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨å¯åŠ¨

```bash
# 1. å¯åŠ¨æœåŠ¡å™¨
node server.js

# 2. å¯åŠ¨å‰ç«¯ï¼ˆæ–°ç»ˆç«¯ï¼‰
npm run dev
```

è®¿é—® http://localhost:5173

---

## ååŒåŠŸèƒ½è¯´æ˜

### âœ… å·²å®ŒæˆåŠŸèƒ½

- **å®æ—¶åŒæ­¥** - å¤šçª—å£å›¾å½¢å®æ—¶åŒæ­¥
- **æˆ¿é—´ç®¡ç†** - åˆ›å»º/åŠ å…¥æˆ¿é—´
- **ç”¨æˆ·ç®¡ç†** - å¤šç”¨æˆ·ååŒç¼–è¾‘
- **å›¾å½¢æ“ä½œ** - æ·»åŠ ã€åˆ é™¤ã€ç§»åŠ¨åŒæ­¥

### ğŸ”§ æŠ€æœ¯å®ç°

#### 1. æ¶ˆæ¯æ ¼å¼

**å‘é€æ ¼å¼**:
```javascript
{
  type: 'command',
  roomId: 'xxx',
  userId: 'xxx',
  timestamp: Date.now(),
  data: {
    operation: {
      command: {
        type: 'add-shape',
        shape: { /* å›¾å½¢æ•°æ® */ }
      }
    }
  }
}
```

**æ¥æ”¶å¤„ç†**:
```javascript
const cmd = message.data.operation?.command;
switch (cmd.type) {
  case 'add-shape':
    const shape = createShapeFromJSON(cmd.shape);
    editor.scene.add(shape);
    break;
}
```

#### 2. å‘½ä»¤æ‹¦æˆª

```javascript
// æ‹¦æˆª CommandManager.execute
const originalExecute = commandManager.execute.bind(commandManager);
commandManager.execute = (command) => {
  originalExecute(command);
  
  if (!isReceivingRemote && ws?.readyState === WebSocket.OPEN) {
    broadcastCommand(command);
  }
};
```

#### 3. é˜²æ­¢å›å£°ï¼ˆEcho Preventionï¼‰

**é—®é¢˜**ï¼š
ç”¨æˆ·æ‹–åŠ¨æ–¹å—æ—¶ï¼Œå¦‚æœç­‰æœåŠ¡å™¨è¿”å›æ‰ç§»åŠ¨ï¼Œå»¶è¿Ÿ 100ms ä¼šæ„Ÿè§‰â€œç²˜æ»â€ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **æœ¬åœ°å…ˆåŠ¨**ï¼šç”¨æˆ·æ“ä½œæ—¶ï¼Œç«‹å³æ›´æ–°æœ¬åœ°è§†å›¾ï¼ŒåŒæ—¶é™é»˜å‘é€æ¶ˆæ¯
2. **å¿½ç•¥å›å£°**ï¼šæœåŠ¡å™¨å¹¿æ’­ç»™æ‰€æœ‰äººï¼ˆåŒ…æ‹¬å‘é€è€…ï¼‰ï¼Œå‰ç«¯åˆ¤æ–­å¿½ç•¥

```javascript
// å‰ç«¯ï¼šSocketClient.ts
private handleMessage(data: string): void {
  const message = JSON.parse(data);
  
  // å¿½ç•¥è‡ªå·±å‘é€çš„æ¶ˆæ¯ï¼ˆé˜²æ­¢å›å£°ï¼‰
  if (message.userId === this.currentUser?.id) {
    return; // â­ å…³é”®ï¼šé¿å…é‡å¤æ‰§è¡Œ
  }
  
  // å¤„ç†å…¶ä»–ç”¨æˆ·çš„æ¶ˆæ¯
  this.emit('shapeUpdated', message.shapeId, message.changes);
}
```

**ä¸ºä»€ä¹ˆä¸åœ¨æœåŠ¡å™¨ç«¯è¿‡æ»¤ï¼Ÿ**
- âœ… å‰ç«¯è¿‡æ»¤æ›´çµæ´»ï¼ˆå¯ä»¥æ ¹æ®ä¸šåŠ¡é€»è¾‘å†³å®šæ˜¯å¦å¿½ç•¥ï¼‰
- âœ… æœåŠ¡å™¨é€»è¾‘æ›´ç®€å•ï¼ˆä¸éœ€è¦è®°å½•å‘é€è€…ï¼‰
- âœ… æ”¯æŒå¤šè®¾å¤‡åŒæ­¥ï¼ˆåŒä¸€ç”¨æˆ·çš„å¤šä¸ªè®¾å¤‡éƒ½èƒ½æ”¶åˆ°ï¼‰

### ğŸ§ª æµ‹è¯•æ–¹æ³•

1. æ‰“å¼€ä¸¤ä¸ªæµè§ˆå™¨çª—å£
2. è¾“å…¥ç›¸åŒæˆ¿é—´ ID
3. åœ¨ä¸€ä¸ªçª—å£ç»˜åˆ¶å›¾å½¢
4. å¦ä¸€ä¸ªçª—å£åº”ç«‹å³æ˜¾ç¤º

**é¢„æœŸæ—¥å¿—**:
```
âœ… WebSocket è¿æ¥æˆåŠŸ
ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: init_sync
ğŸ“¤ å‘é€å‘½ä»¤: add-shape
ğŸ¨ æ”¶åˆ°è¿œç¨‹æ“ä½œ: add-shape
âœ… æ·»åŠ è¿œç¨‹å›¾å½¢: Rect abc123
```

---

## é¡¹ç›®ç»“æ„

### æ ¹ç›®å½•æ–‡ä»¶

```
webååŒç”»æ¿/
â”œâ”€â”€ src/                    # å‰ç«¯æºç 
â”œâ”€â”€ server/                 # å®Œæ•´ç‰ˆæœåŠ¡å™¨ï¼ˆMongoDBï¼‰
â”œâ”€â”€ server.js               # ç®€å•ç‰ˆæœåŠ¡å™¨ï¼ˆå†…å­˜ï¼‰
â”œâ”€â”€ package.json            # å‰ç«¯ä¾èµ–
â”œâ”€â”€ vite.config.ts          # Vite é…ç½®
â”œâ”€â”€ tsconfig.json           # TypeScript é…ç½®
â”œâ”€â”€ index.html              # HTML å…¥å£
â”œâ”€â”€ start-simple.bat/sh     # ç®€å•ç‰ˆå¯åŠ¨è„šæœ¬
â”œâ”€â”€ start-dev.bat/sh        # å®Œæ•´ç‰ˆå¯åŠ¨è„šæœ¬
â”œâ”€â”€ README.md               # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ å¼€å‘æŒ‡å—.md             # æœ¬æ–‡ä»¶
â”œâ”€â”€ å¼€å‘ç¬”è®°.md             # å¼€å‘è¿‡ç¨‹è®°å½•
â”œâ”€â”€ é¢è¯•æŒ‡å—.md             # é¢è¯•é—®é¢˜ç­”æ¡ˆ
â”œâ”€â”€ API.md                  # API æ–‡æ¡£
â”œâ”€â”€ DEPLOYMENT.md           # éƒ¨ç½²æŒ‡å—
â””â”€â”€ CHANGELOG.md            # æ›´æ–°æ—¥å¿—
```

### æ ¸å¿ƒæ¨¡å—

```
src/core/
â”œâ”€â”€ math/                   # æ•°å­¦åº“
â”‚   â”œâ”€â”€ Vector.ts           # å‘é‡è¿ç®—
â”‚   â”œâ”€â”€ Matrix.ts           # çŸ©é˜µå˜æ¢
â”‚   â””â”€â”€ AABB.ts             # åŒ…å›´ç›’
â”œâ”€â”€ shapes/                 # å›¾å½¢ç³»ç»Ÿ
â”‚   â”œâ”€â”€ Shape.ts            # åŸºç±»
â”‚   â”œâ”€â”€ Rect.ts             # çŸ©å½¢
â”‚   â”œâ”€â”€ Circle.ts           # åœ†å½¢
â”‚   â”œâ”€â”€ Line.ts             # çº¿æ¡
â”‚   â””â”€â”€ index.ts            # å·¥å‚å‡½æ•°
â”œâ”€â”€ tools/                  # å·¥å…·ç³»ç»Ÿ
â”‚   â”œâ”€â”€ SelectTool.ts       # é€‰æ‹©
â”‚   â”œâ”€â”€ RectTool.ts         # çŸ©å½¢
â”‚   â””â”€â”€ ...
â”œâ”€â”€ commands/               # å‘½ä»¤ç³»ç»Ÿ
â”‚   â”œâ”€â”€ AddShapeCommand.ts
â”‚   â”œâ”€â”€ RemoveShapeCommand.ts
â”‚   â””â”€â”€ ...
â”œâ”€â”€ Editor.ts               # ç¼–è¾‘å™¨ä¸»ç±»
â”œâ”€â”€ Scene.ts                # åœºæ™¯ç®¡ç†
â”œâ”€â”€ RenderEngine.ts         # æ¸²æŸ“å¼•æ“
â””â”€â”€ SocketClient.ts         # WebSocket å®¢æˆ·ç«¯
```

---

## æœåŠ¡å™¨é€‰æ‹©

### ç®€å•ç‰ˆ (server.js)

**ç‰¹ç‚¹**:
- âœ… æ— éœ€æ•°æ®åº“
- âœ… å¯åŠ¨å¿«é€Ÿï¼ˆå³æ—¶ï¼‰
- âœ… ä»£ç ç®€å•ï¼ˆ~350 è¡Œï¼‰
- âœ… å†…å­˜å ç”¨ä½ï¼ˆ~50MBï¼‰
- âœ… å¤šæˆ¿é—´æ”¯æŒ
- âœ… å®Œæ•´çŠ¶æ€åŒæ­¥ï¼ˆinit_syncï¼‰
- âœ… æ“ä½œå†å²è®°å½•ï¼ˆé™åˆ¶1000æ¡ï¼‰
- âŒ é‡å¯åæ•°æ®ä¸¢å¤±

**é€‚ç”¨åœºæ™¯**:
- å¼€å‘è°ƒè¯•
- åŠŸèƒ½æ¼”ç¤º
- æ•™å­¦å­¦ä¹ 
- å°è§„æ¨¡ååŒï¼ˆ<100ç”¨æˆ·ï¼‰

**å¯åŠ¨**:
```bash
node server.js
```

**æ”¯æŒçš„æ¶ˆæ¯ç±»å‹**:
- `join` - ç”¨æˆ·åŠ å…¥æˆ¿é—´
- `leave` - ç”¨æˆ·ç¦»å¼€æˆ¿é—´
- `cursor` - å…‰æ ‡ä½ç½®æ›´æ–°
- `selection` - é€‰æ‹©çŠ¶æ€æ›´æ–°
- `lock/unlock` - å›¾å½¢é”å®š/è§£é”
- `command` - æ“ä½œå‘½ä»¤ï¼ˆæ·»åŠ ã€åˆ é™¤ã€ä¿®æ”¹å›¾å½¢ï¼‰

### å®Œæ•´ç‰ˆ (server/)

**ç‰¹ç‚¹**:
- âœ… MongoDB æŒä¹…åŒ–
- âœ… REST API
- âœ… æˆ¿é—´ç®¡ç†
- âœ… æ“ä½œå†å²
- âœ… ç”Ÿäº§å°±ç»ª
- âŒ éœ€è¦ MongoDB
- âŒ é…ç½®å¤æ‚

**é€‚ç”¨åœºæ™¯**:
- ç”Ÿäº§éƒ¨ç½²
- æ•°æ®æŒä¹…åŒ–
- å¤§è§„æ¨¡ä½¿ç”¨

**å¯åŠ¨**:
```bash
cd server
npm run dev
```

### æ€§èƒ½å¯¹æ¯”

| ç‰¹æ€§ | ç®€å•ç‰ˆ | å®Œæ•´ç‰ˆ |
|------|--------|--------|
| å¯åŠ¨é€Ÿåº¦ | âš¡ å³æ—¶ | ğŸ¢ 2-3ç§’ |
| å†…å­˜å ç”¨ | ğŸ’š 50MB | ğŸ’› 150MB |
| æ•°æ®æŒä¹…åŒ– | âŒ | âœ… |
| å¤šæˆ¿é—´æ”¯æŒ | âœ… | âœ… |
| æ“ä½œå†å² | âœ… (å†…å­˜) | âœ… (æ•°æ®åº“) |
| çŠ¶æ€åŒæ­¥ | âœ… | âœ… |
| å¹¶å‘ç”¨æˆ· | <100 | >1000 |

---

## å¸¸è§é—®é¢˜

### Q: å®æ—¶åŒæ­¥ä¸ç”Ÿæ•ˆï¼Ÿ

**æ£€æŸ¥æ¸…å•**:
1. WebSocket æ˜¯å¦è¿æ¥ï¼š`ws?.readyState === 1`
2. æˆ¿é—´ ID æ˜¯å¦ç›¸åŒ
3. æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
4. æ˜¯å¦è°ƒç”¨äº† `renderer.requestRender()`

### Q: å†å²å›¾å½¢ä¸æ˜¾ç¤ºï¼Ÿ

**åŸå› **ï¼š
1. MongoDB Schema å®šä¹‰é”™è¯¯
2. æ•°æ®ä¿å­˜å¤±è´¥
3. å‰ç«¯è§£ææ•°æ®ç»“æ„é”™è¯¯

**è§£å†³**ï¼š
1. æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ï¼š`[WS] Room xxx has N shapes`
2. æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ï¼š`[WS] âŒ Command error`
3. æ¸…ç©ºæ•°æ®åº“é‡æ–°æµ‹è¯•ï¼š`db.rooms.deleteMany({})`

### Q: å›¾å½¢ä¸åŒæ­¥ï¼Ÿ

**æ£€æŸ¥æ¸…å•**:
1. WebSocket æ˜¯å¦è¿æ¥ï¼š`ws?.readyState === 1`
2. æˆ¿é—´ ID æ˜¯å¦ç›¸åŒ
3. æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
4. æ˜¯å¦è°ƒç”¨äº† `renderer.requestRender()`

**è°ƒè¯•æ–¹æ³•**:
```javascript
// æŸ¥çœ‹ WebSocket çŠ¶æ€
console.log('WSçŠ¶æ€:', ws?.readyState);

// æŸ¥çœ‹æˆ¿é—´ä¿¡æ¯
console.log('æˆ¿é—´ID:', currentRoomId.value);

// æ‰‹åŠ¨å‘é€æµ‹è¯•æ¶ˆæ¯
ws.send(JSON.stringify({
  type: 'command',
  roomId: 'test',
  userId: 'test123',
  data: {
    operation: {
      command: {
        type: 'add-shape',
        shape: { type: 'Rect', x: 100, y: 100, width: 50, height: 50 }
      }
    }
  }
}));
```

### Q: å¦‚ä½•æ·»åŠ æ–°å›¾å½¢ç±»å‹ï¼Ÿ

1. åˆ›å»ºå›¾å½¢ç±»ï¼ˆç»§æ‰¿ `Shape`ï¼‰
2. å®ç° `draw()`, `hitTest()`, `getBoundingBox()`
3. å®ç° `toJSON()` å’Œ `fromJSON()`
4. åœ¨ `shapes/index.ts` æ·»åŠ åˆ°å·¥å‚å‡½æ•°

```typescript
// 1. åˆ›å»ºå›¾å½¢ç±»
export class Triangle extends Shape {
  draw(ctx: CanvasRenderingContext2D) { /* ... */ }
  hitTest(point: Vector): boolean { /* ... */ }
  getBoundingBox(): AABB { /* ... */ }
  toJSON() { return { type: 'Triangle', /* ... */ }; }
  static fromJSON(json: any): Triangle { /* ... */ }
}

// 2. æ·»åŠ åˆ°å·¥å‚å‡½æ•°
export function createShapeFromJSON(json: any): Shape {
  switch (json.type) {
    case 'Triangle': return Triangle.fromJSON(json);
    // ...
  }
}
```

### Q: å¦‚ä½•æ·»åŠ æ–°å·¥å…·ï¼Ÿ

1. åˆ›å»ºå·¥å…·ç±»ï¼ˆç»§æ‰¿ `Tool`ï¼‰
2. å®ç°é¼ æ ‡äº‹ä»¶å¤„ç†
3. åœ¨ `ToolManager` æ³¨å†Œ

```typescript
export class TriangleTool extends Tool {
  onMouseDown(point: Vector, event: MouseEvent) { /* ... */ }
  onMouseMove(point: Vector, event: MouseEvent) { /* ... */ }
  onMouseUp(point: Vector, event: MouseEvent) { /* ... */ }
}
```

### Q: å¦‚ä½•ä¼˜åŒ–æ€§èƒ½ï¼Ÿ

1. **å¯ç”¨å››å‰æ ‘** - å¤§é‡å›¾å½¢æ—¶ä¼˜åŒ–æŸ¥è¯¢
```typescript
scene.setUseQuadTree(true);
```

2. **èŠ‚æµæ¸²æŸ“** - é¿å…é¢‘ç¹é‡ç»˜
```typescript
renderer.requestRender(); // è‡ªåŠ¨èŠ‚æµ
```

3. **æ‰¹é‡æ“ä½œ** - ä½¿ç”¨ `addMany()` è€Œä¸æ˜¯å¤šæ¬¡ `add()`
```typescript
scene.addMany([shape1, shape2, shape3]);
```

### Q: å¦‚ä½•éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ

å‚è€ƒ [DEPLOYMENT.md](./DEPLOYMENT.md)

---

---

## ğŸ“¡ API å¿«é€Ÿå‚è€ƒ

### Editor API

```typescript
// åˆ›å»ºç¼–è¾‘å™¨
const editor = new Editor({
  canvas: canvasElement,
  backgroundColor: '#ffffff',
  showGrid: true
});

// æ·»åŠ å›¾å½¢
const rect = new Rect({ x: 100, y: 100, width: 200, height: 100 });
editor.addShape(rect);

// åˆ‡æ¢å·¥å…·
editor.setTool('rect'); // 'select' | 'rect' | 'circle' | 'pen' | 'brush'

// æ’¤é”€/é‡åš
editor.undo();
editor.redo();

// å¯¼å‡º/å¯¼å…¥
const json = editor.toJSON();
editor.fromJSON(json);
```

### Shape API

```typescript
// çŸ©å½¢
const rect = new Rect({ x: 100, y: 100, width: 200, height: 100 });

// åœ†å½¢
const circle = new Circle({ x: 200, y: 200, radius: 50 });

// çº¿æ¡
const line = new Line({
  points: [new Vector(0, 0), new Vector(100, 100)],
  smooth: true,
  smoothAlgorithm: 'catmullRom'
});

// æ–‡æœ¬
const text = new Text({ x: 100, y: 100, content: 'Hello' });
```

### Vue Composable

```vue
<script setup>
import { useEditor } from '@/hooks/useEditor';

const canvasRef = ref(null);
const { currentTool, setTool, undo, redo } = useEditor({ canvasRef });
</script>
```

å®Œæ•´ API æ–‡æ¡£è¯·æŸ¥çœ‹æºç æ³¨é‡Šã€‚

---

## ğŸš€ éƒ¨ç½²æŒ‡å—

### æœ¬åœ°å¼€å‘

```bash
# 1. å¯åŠ¨ MongoDB
mongod

# 2. å¯åŠ¨åç«¯
cd server && npm run dev

# 3. å¯åŠ¨å‰ç«¯
npm run dev
```

### ç”Ÿäº§éƒ¨ç½²

**å‰ç«¯ï¼ˆVercel/Netlifyï¼‰**:
```bash
npm run build
vercel --prod
```

**åç«¯ï¼ˆRailway/Renderï¼‰**:
```bash
cd server
npm start
```

**Docker**:
```bash
docker-compose up -d
```

### ç¯å¢ƒå˜é‡

```env
# åç«¯ .env
PORT=3000
MONGODB_URI=mongodb://localhost:27017/whiteboard
CORS_ORIGIN=http://localhost:5173

# å‰ç«¯ .env.production
VITE_API_URL=https://api.example.com
VITE_WS_URL=wss://api.example.com
```

è¯¦ç»†éƒ¨ç½²æ­¥éª¤è¯·æŸ¥çœ‹ `server/README.md`ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [README.md](./README.md) - é¡¹ç›®æ¦‚è¿°
- [å¼€å‘ç¬”è®°.md](./å¼€å‘ç¬”è®°.md) - å¼€å‘è¿‡ç¨‹
- [é¢è¯•æŒ‡å—.md](./é¢è¯•æŒ‡å—.md) - é¢è¯•å‡†å¤‡

---

**æœ€åæ›´æ–°**: 2024-12
**çŠ¶æ€**: âœ… ååŒåŠŸèƒ½å·²ä¿®å¤å¹¶æµ‹è¯•é€šè¿‡
